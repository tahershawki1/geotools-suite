<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>حساب المساحات</title>

  <!-- Local Leaflet (no Google, no external scripts) -->
  <link rel="stylesheet" href="./vendor/leaflet/leaflet.css" />
<script src="./vendor/leaflet/leaflet.js"></script>


  <style>
    :root{
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #111827;
      --muted: #374151;
      --border: rgba(0,0,0,.12);
      --soft: #f9fafb;
      --primary: #2563eb;
      --secondary: #475569;
      --danger: #dc2626;
      --warn: #f59e0b;
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header{
      padding: 14px 18px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    header h1{
      margin:0;
      font-size: 18px;
      font-weight: 800;
    }

    .wrap{
      height: calc(100% - 56px);
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      padding: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      min-width: 0;
    }

    .card h2{
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 800;
    }

    textarea{
      width: 100%;
      min-height: 220px;
      resize: vertical;
      background: #fff;
      color: var(--text);
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 10px;
      padding: 10px;
      line-height: 1.55;
      font-family: Consolas, "Courier New", monospace;
      font-size: 13px;
    }

    .row{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    button{
      background: var(--primary);
      color: #fff;
      border: 0;
      border-radius: 10px;
      padding: 9px 12px;
      font-weight: 800;
      cursor: pointer;
    }
    button.secondary{ background: var(--secondary); }
    button.danger{ background: var(--danger); }

    .hint{
      margin-top: 10px;
      background: var(--soft);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }

    .msg{
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(37,99,235,.25);
      background: rgba(37,99,235,.08);
      font-size: 13px;
      display:none;
    }
    .msg.warn{
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.12);
    }
    .msg.err{
      border-color: rgba(220,38,38,.35);
      background: rgba(220,38,38,.12);
    }

    .results{
      margin-top: 10px;
      display:none;
      gap: 8px;
    }
    .result-item{
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 10px;
      border-radius: 10px;
      background: var(--soft);
      border: 1px solid var(--border);
    }
    .result-val{
      font-weight: 900;
      direction:ltr;
    }

    .map-card{
      padding: 12px;
    }
    #map{
      flex: 1;
      min-height: 520px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
    }

    input[type="file"]{ display:none; }

    /* Leaflet tweaks for better visibility in light theme */
    .leaflet-container { background: #ffffff; }
  </style>
</head>

<body>
<header>
  <h1>حساب المساحات (N, E) — وضع مستوي (UTM/محلي)</h1>
</header>

<div class="wrap">
  <div class="card">
    <h2>إدخال النقاط</h2>

    <textarea id="coordsInput" placeholder="كل سطر = نقطة واحدة

أمثلة مقبولة:
N, E
N E
1, N, E
1 N E

يدعم: , أو ; أو مسافات أو Tab"></textarea>

    <div class="row">
      <button id="btnDraw" type="button">رسم وحساب</button>
      <button id="btnClose" type="button" class="secondary">إغلاق المضلع</button>
      <button id="btnImport" type="button" class="secondary">استيراد CSV/TXT</button>
      <button id="btnClear" type="button" class="danger">مسح</button>
      <input id="fileInput" type="file" accept=".csv,.txt" />
    </div>

    <div class="hint">
      <div>• هذه الصفحة تعمل دون إنترنت (لا Tiles). تظهر شبكة للمساعدة في القراءة.</div>
      <div>• اعتبر الإحداثيات (N,E) بوحدة المتر أو أي وحدة خطية، فتكون المساحة (وحدة²).</div>
      <div>• إذا كانت النقاط لا تظهر: غالبًا Leaflet لم يُحمّل (مسار vendor/leaflet) أو أن الصفحة ليست داخل docs.</div>
      <div style="direction:ltr; margin-top:8px;">
        مثال سريع للاختبار:<br/>
        3000, 5000<br/>
        3050, 5080<br/>
        2980, 5120<br/>
        2950, 5030
      </div>
    </div>

    <div id="message" class="msg"></div>

    <div class="results" id="areaResults">
      <div class="result-item">
        <span>عدد النقاط:</span>
        <span class="result-val"><span id="res-count">0</span></span>
      </div>
      <div class="result-item">
        <span>المساحة:</span>
        <span class="result-val"><span id="res-area">0</span></span>
      </div>
      <div class="result-item">
        <span>المحيط:</span>
        <span class="result-val"><span id="res-perimeter">0</span></span>
      </div>
    </div>
  </div>

  <div class="card map-card">
    <div id="map"></div>
  </div>
</div>

<script src="vendor/leaflet/leaflet.js"></script>
<script>
(function(){
  // --- Hard stop if Leaflet not loaded ---
  if (typeof L === 'undefined') {
    const el = document.getElementById('message');
    el.className = 'msg err';
    el.style.display = 'block';
    el.textContent =
      'Leaflet لم يتم تحميله. تأكد أن الملف Service2.html داخل مجلد docs وأن المسار docs/vendor/leaflet/leaflet.js موجود.';
    return;
  }

  // --- UI elements ---
  const elInput   = document.getElementById('coordsInput');
  const elMsg     = document.getElementById('message');
  const elResults = document.getElementById('areaResults');

  const btnDraw   = document.getElementById('btnDraw');
  const btnClose  = document.getElementById('btnClose');
  const btnImport = document.getElementById('btnImport');
  const btnClear  = document.getElementById('btnClear');
  const fileInput = document.getElementById('fileInput');

  function showMsg(text, kind){
    elMsg.style.display = 'block';
    elMsg.className = 'msg' + (kind ? (' ' + kind) : '');
    elMsg.textContent = text;
  }
  function hideMsg(){
    elMsg.style.display = 'none';
    elMsg.textContent = '';
  }
  function fmt(num, maxFrac){
    return Number(num).toLocaleString(undefined, { maximumFractionDigits: maxFrac ?? 3 });
  }

  // --- Robust parsing (supports: N,E | N E | id,N,E | id N E | extra cols -> last two) ---
  function extractNumbers(line){
    const cleaned = (line || '').trim();
    if(!cleaned) return [];

    const tokens = cleaned
      .replace(/;/g, ',')
      .replace(/\t/g, ' ')
      .split(/[, ]+/)
      .filter(Boolean);

    const nums = [];
    for(const raw of tokens){
      let t = raw.trim();
      if(!/[0-9]/.test(t)) continue;

      // allow decimal comma in isolated token, convert to dot
      if(t.includes(',') && !t.includes('.')){
        const c = (t.match(/,/g)||[]).length;
        if(c === 1) t = t.replace(',', '.');
      }

      t = t.replace(/[^\d.+-]/g, '');
      const v = Number.parseFloat(t);
      if(Number.isFinite(v)) nums.push(v);
    }
    return nums;
  }

  function parsePoints(text){
    const lines = String(text || '').split(/\r?\n/);
    const pts = [];
    const bad = [];

    for(let i=0;i<lines.length;i++){
      const nums = extractNumbers(lines[i]);
      if(nums.length === 0) continue;

      let N, E;
      if(nums.length === 2){
        [N, E] = nums;
      } else if(nums.length >= 3){
        // ignore id/extra columns => take last two as N,E
        N = nums[nums.length - 2];
        E = nums[nums.length - 1];
      } else {
        bad.push(i+1);
        continue;
      }

      if(!Number.isFinite(N) || !Number.isFinite(E)){
        bad.push(i+1);
        continue;
      }
      pts.push({ N, E });
    }

    return { pts, badLines: bad };
  }

  function pointsEqual(a,b, eps=1e-9){
    return Math.abs(a.N - b.N) < eps && Math.abs(a.E - b.E) < eps;
  }

  function normalizeClosedDuplicate(pts){
    if(pts.length >= 2 && pointsEqual(pts[0], pts[pts.length - 1])){
      return pts.slice(0, -1);
    }
    return pts;
  }

  // --- Math (Shoelace with x=E, y=N) ---
  function computeAreaPerimeter(pts){
    const n = pts.length;
    if(n < 2) return { area: 0, perimeter: 0 };

    let sum = 0;
    let per = 0;

    for(let i=0;i<n;i++){
      const a = pts[i];
      const b = pts[(i+1) % n];

      // perimeter always computed for closed loop intent
      per += Math.hypot((b.E - a.E), (b.N - a.N));

      if(n >= 3){
        sum += (a.E * b.N) - (b.E * a.N);
      }
    }

    const area = (n >= 3) ? (Math.abs(sum) / 2) : 0;
    return { area, perimeter: per };
  }

  // --- Leaflet map (planar / CRS.Simple) ---
  const map = L.map('map', { crs: L.CRS.Simple, minZoom: -10, zoomSnap: 0.25 });

  // force Leaflet to compute sizes after layout
  setTimeout(() => map.invalidateSize(), 0);
  window.addEventListener('resize', () => map.invalidateSize());

  // Layers
  let gridLayer = null;
  let pointsLayer = null;
  let lineLayer = null;
  let polyLayer = null;

  function clearDraw(){
    if(pointsLayer){ map.removeLayer(pointsLayer); pointsLayer = null; }
    if(lineLayer){ map.removeLayer(lineLayer); lineLayer = null; }
    if(polyLayer){ map.removeLayer(polyLayer); polyLayer = null; }
  }

  function buildGrid(bounds, step){
    const yMin = bounds.getSouth();
    const yMax = bounds.getNorth();
    const xMin = bounds.getWest();
    const xMax = bounds.getEast();

    const lines = [];

    for(let x = Math.floor(xMin/step)*step; x <= xMax; x += step){
      lines.push([[yMin, x],[yMax, x]]);
    }
    for(let y = Math.floor(yMin/step)*step; y <= yMax; y += step){
      lines.push([[y, xMin],[y, xMax]]);
    }

    return L.polyline(lines, { weight: 1, opacity: 0.25 });
  }

  function setGridToBounds(bounds){
    if(gridLayer){ map.removeLayer(gridLayer); gridLayer = null; }

    const width  = Math.abs(bounds.getEast() - bounds.getWest());
    const height = Math.abs(bounds.getNorth() - bounds.getSouth());
    const span = Math.max(width, height);

    let step = 100;
    if(span > 50000) step = 5000;
    else if(span > 10000) step = 1000;
    else if(span > 2000)  step = 200;
    else if(span > 500)   step = 50;
    else if(span > 100)   step = 10;

    gridLayer = buildGrid(bounds, step).addTo(map);
  }

  // initial neutral view + grid
  const initBounds = L.latLngBounds([[0,0],[1000,1000]]);
  map.fitBounds(initBounds);
  setGridToBounds(initBounds);

  function toLatLngs(pts){
    // CRS.Simple expects [y, x] -> [N, E]
    return pts.map(p => [p.N, p.E]);
  }

  function render(ptsInput){
    hideMsg();
    clearDraw();

    const pts = normalizeClosedDuplicate(ptsInput);

    if(pts.length < 2){
      elResults.style.display = 'none';
      showMsg('أدخل نقطتين على الأقل للرسم.', 'warn');
      return;
    }

    const latlngs = toLatLngs(pts);

    // markers
    pointsLayer = L.layerGroup();
    latlngs.forEach((ll, idx) => {
      const m = L.circleMarker(ll, { radius: 6, weight: 2, fillOpacity: 0.85 });
      m.bindTooltip(
        `P${idx+1}<br/>N=${fmt(pts[idx].N,3)}<br/>E=${fmt(pts[idx].E,3)}`,
        { sticky: true }
      );
      m.addTo(pointsLayer);
    });
    pointsLayer.addTo(map);

    // closed polyline
    const closed = latlngs.slice();
    closed.push(latlngs[0]);
    lineLayer = L.polyline(closed, { weight: 3, opacity: 0.95 }).addTo(map);

    // polygon if >=3
    if(pts.length >= 3){
      polyLayer = L.polygon(latlngs, { weight: 2, fillOpacity: 0.20 }).addTo(map);
    }

    // Fit to points (this is the key fix: no fixed [-1000..1000])
    const b = L.latLngBounds(latlngs);
    map.fitBounds(b.pad(0.2));
    setGridToBounds(b.pad(0.2));

    // Stats
    const stats = computeAreaPerimeter(pts);

    document.getElementById('res-count').innerText = String(pts.length);
    document.getElementById('res-area').innerText = fmt(stats.area, 3);
    document.getElementById('res-perimeter').innerText = fmt(stats.perimeter, 3);

    elResults.style.display = 'grid';

    if(pts.length < 3){
      showMsg('تم الرسم. حساب المساحة يحتاج 3 نقاط على الأقل.', 'warn');
    } else {
      showMsg('تم الرسم والحساب بنجاح.', '');
    }
  }

  function closePolygon(){
    const { pts, badLines } = parsePoints(elInput.value);
    if(badLines.length){
      showMsg(`أسطر غير مفهومة: ${badLines.join(', ')}. صححها ثم أعد المحاولة.`, 'err');
      return;
    }
    if(pts.length < 3){
      showMsg('لا يمكن إغلاق المضلع: تحتاج 3 نقاط على الأقل.', 'warn');
      return;
    }
    const alreadyClosed = (pts.length >= 2 && pointsEqual(pts[0], pts[pts.length-1]));
    if(alreadyClosed){
      showMsg('المضلع مغلق بالفعل (آخر نقطة = الأولى).', '');
      return;
    }
    const first = pts[0];
    let text = elInput.value;
    if(text.trim().length === 0){
      showMsg('لا يوجد إدخال لإغلاقه.', 'warn');
      return;
    }
    if(!text.endsWith('\n')) text += '\n';
    text += `${first.N}, ${first.E}\n`;
    elInput.value = text;
    showMsg('تمت إضافة أول نقطة في نهاية الإدخال لإغلاق المضلع.', '');
  }

  function importFromFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      const content = String(reader.result || '');
      const { pts, badLines } = parsePoints(content);

      if(!pts.length){
        showMsg('لم يتم العثور على نقاط صالحة داخل الملف.', 'err');
        return;
      }
      if(badLines.length){
        showMsg(`تم الاستيراد مع تجاهل أسطر غير مفهومة: ${badLines.join(', ')}.`, 'warn');
      } else {
        showMsg('تم استيراد النقاط بنجاح.', '');
      }

      elInput.value = pts.map(p => `${p.N}, ${p.E}`).join('\n') + '\n';
    };
    reader.onerror = () => showMsg('تعذر قراءة الملف.', 'err');
    reader.readAsText(file);
  }

  // --- Events ---
  btnDraw.addEventListener('click', () => {
    const { pts, badLines } = parsePoints(elInput.value);
    if(badLines.length){
      showMsg(`أسطر غير مفهومة: ${badLines.join(', ')}. كل سطر يجب أن يحتوي N و E.`, 'err');
      return;
    }
    if(!pts.length){
      showMsg('أدخل نقاطًا أولًا.', 'warn');
      return;
    }
    render(pts);
  });

  btnClose.addEventListener('click', closePolygon);

  btnImport.addEventListener('click', () => {
    fileInput.value = '';
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if(f) importFromFile(f);
  });

  btnClear.addEventListener('click', () => {
    elInput.value = '';
    elResults.style.display = 'none';
    clearDraw();
    hideMsg();
    showMsg('تم مسح الإدخال والرسم.', '');
  });

  showMsg('جاهز. أدخل نقاطك ثم اضغط "رسم وحساب".', '');
})();
</script>
</body>
</html>
