<style>
  .container-dltm {
    max-width: 900px;
    width: 100%;
    margin: 0 auto;
    background:#fff;
    border:1px solid var(--border);
    border-radius: 24px;
    overflow:hidden;
    box-shadow: var(--shadow-lg);
    margin-top: 20px;
    display: flex;
    flex-direction: column;
  }
  .header-dltm { padding:25px; border-bottom: 1px solid var(--border); background:#fff; display: flex; justify-content: space-between; align-items: center; }
  .dltm-tabs { display: flex; border-bottom: 1px solid var(--border); background: #f8fafc; }
  .dltm-tab { padding: 15px 30px; cursor: pointer; font-weight: 700; color: var(--text-muted); border-bottom: 3px solid transparent; transition: all 0.2s; }
  .dltm-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: #fff; }

  .content-dltm { padding: 30px; }
  .tool-section { display: none; }
  .tool-section.active { display: block; }

  .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
  .input-group label { display: block; font-weight: 700; margin-bottom: 8px; color: var(--text-main); font-size: 14px; }
  .input-group input { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid var(--border); font-size: 16px; outline: none; }

  .batch-dropzone { border: 2px dashed var(--border); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc; }
  .batch-dropzone:hover { border-color: var(--primary); background: var(--primary-light); }

  .results-table-wrap { margin-top: 30px; border: 1px solid var(--border); border-radius: 16px; overflow: hidden; display: none; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { background: #f1f5f9; padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
  td { padding: 12px; border-bottom: 1px solid var(--border); }

  .btn-calc { width:100%; padding: 14px; border:none; border-radius: 12px; background:var(--primary); color:#fff; font-weight:700; font-size:16px; cursor:pointer; }
  .btn-calc:hover { background: var(--primary-hover); }

  #res-box-single { margin-top: 25px; background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid var(--border); display: none; }
  .res-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; }
  .res-val { color: var(--primary); font-family: monospace; }
</style>

<div class="container-dltm">
  <div class="header-dltm">
    <div style="text-align: right; direction: rtl;">
      <h2 style="font-size:20px; font-weight:900; color:var(--primary); margin:0;">ğŸ“ Ù…Ø­ÙˆÙ„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¯Ø¨ÙŠ (DLTM)</h2>
      <p style="font-size:13px; color:var(--text-muted); margin:0;">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† DLTM Ùˆ WGS84</p>
    </div>
    <button class="btn-nav-top" onclick="loadPage('')">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  </div>

  <div class="dltm-tabs">
    <div class="dltm-tab active" onclick="switchDltmTab(this, 'single')">ØªØ­ÙˆÙŠÙ„ ÙØ±Ø¯ÙŠ</div>
    <div class="dltm-tab" onclick="switchDltmTab(this, 'batch')">ØªØ­ÙˆÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ (CSV)</div>
  </div>

  <div class="content-dltm">
    <!-- Single Conversion -->
    <div id="section-single" class="tool-section active">
      <div class="input-grid">
        <div class="input-group">
          <label>Easting (X)</label>
          <input type="number" id="inp-e" placeholder="500000.00">
        </div>
        <div class="input-group">
          <label>Northing (Y)</label>
          <input type="number" id="inp-n" placeholder="2768000.00">
        </div>
      </div>
      <button class="btn-calc" id="btn-convert-single" onclick="runSingleDltm()">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù† âœ¨</button>

      <div id="res-box-single">
         <div class="res-row"><span>Latitude (N):</span> <span class="res-val" id="res-lat">-</span></div>
         <div class="res-row"><span>Longitude (E):</span> <span class="res-val" id="res-lon">-</span></div>
         <div class="res-row"><span>UTM Zone:</span> <span class="res-val" id="res-utm-z">-</span></div>
         <div class="res-row"><span>UTM E:</span> <span class="res-val" id="res-utm-e">-</span></div>
         <div class="res-row"><span>UTM N:</span> <span class="res-val" id="res-utm-n">-</span></div>
      </div>
    </div>

    <!-- Batch Conversion -->
    <div id="section-batch" class="tool-section">
      <div class="batch-dropzone" onclick="document.getElementById('batchFile').click()">
        <span style="font-size: 40px;">ğŸ“„</span>
        <h3 style="margin: 10px 0;">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ù…Ù„Ù CSV</h3>
        <p style="font-size: 13px; color: var(--text-muted);">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© (E, N) ÙˆÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© (PointID, Code) Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§</p>
        <input type="file" id="batchFile" style="display: none;" accept=".csv,.txt" onchange="handleBatchFile(this)">
      </div>

      <div class="results-table-wrap" id="batchResultsWrap">
        <div style="padding: 15px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
          <strong id="batchCount">0 Ù†Ù‚Ø§Ø· ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§</strong>
          <button class="btn-nav-top" onclick="downloadBatchCsv()">ØªØ­Ù…ÙŠÙ„ CSV ğŸ’¾</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
          <table id="batchTable">
            <thead>
              <tr>
                <th>Point</th>
                <th>Code</th>
                <th>E (DLTM)</th>
                <th>N (DLTM)</th>
                <th>Lat</th>
                <th>Lon</th>
                <th>UTM Zone</th>
                <th>UTM E</th>
                <th>UTM N</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  // ----------------------------
  // Minimal Loader Fallback
  // (Index.html Ø¹Ù†Ø¯Ùƒ ÙÙŠÙ‡ showLoader Ø¨Ø§Ù„ÙØ¹Ù„)
  // ----------------------------
  function safeShowLoader(show) {
    try {
      if (typeof showLoader === "function") return showLoader(show);
    } catch {}
    // fallback: no-op
  }

  // ----------------------------
  // Tabs
  // ----------------------------
  window.switchDltmTab = function (el, tab) {
    document.querySelectorAll(".dltm-tab").forEach((t) => t.classList.remove("active"));
    document.querySelectorAll(".tool-section").forEach((s) => s.classList.remove("active"));
    el.classList.add("active");
    document.getElementById("section-" + tab).classList.add("active");
  };

  // ----------------------------
  // Core Math (Ported from DLTM_Utils.gs)
  // Parameters from your screenshot:
  // - WGS84 ellipsoid
  // - TM: lon0 = 55Â°20'00"E, k0=1.0, FE=500000, FN=0
  // ----------------------------
  function degToRad(deg) { return (deg * Math.PI) / 180; }
  function radToDeg(rad) { return (rad * 180) / Math.PI; }

  function calculateMeridionalArc(phi, a, e2) {
    return (
      a *
      ((1 - e2 / 4 - (3 * e2 * e2) / 64 - (5 * Math.pow(e2, 3)) / 256) * phi -
        ((3 * e2) / 8 + (3 * e2 * e2) / 32 + (45 * Math.pow(e2, 3)) / 1024) * Math.sin(2 * phi) +
        ((15 * e2 * e2) / 256 + (45 * Math.pow(e2, 3)) / 1024) * Math.sin(4 * phi) -
        ((35 * Math.pow(e2, 3)) / 3072) * Math.sin(6 * phi))
    );
  }

  function latLonToUTM(latDeg, lonDeg) {
    // WGS84
    const a = 6378137.0;
    const invF = 298.257223563;
    const f = 1 / invF;
    const b = a * (1 - f);

    const e2 = (a * a - b * b) / (a * a);
    const ep2 = (a * a - b * b) / (b * b);

    const lat = degToRad(latDeg);
    const lon = degToRad(lonDeg);

    let zone = Math.floor((lonDeg + 180) / 6) + 1;
    if (zone < 1) zone = 1;
    if (zone > 60) zone = 60;

    const hemisphere = latDeg >= 0 ? "N" : "S";
    const lon0Deg = (zone - 1) * 6 - 180 + 3;
    const lon0 = degToRad(lon0Deg);

    const k0 = 0.9996;
    const E0 = 500000.0;
    const N0 = hemisphere === "S" ? 10000000.0 : 0.0;

    const sinLat = Math.sin(lat);
    const cosLat = Math.cos(lat);
    const tanLat = Math.tan(lat);

    const N = a / Math.sqrt(1 - e2 * sinLat * sinLat);
    const T = tanLat * tanLat;
    const C = ep2 * cosLat * cosLat;
    const A = (lon - lon0) * cosLat;

    const M = calculateMeridionalArc(lat, a, e2);

    const easting =
      E0 +
      k0 *
        N *
        (A +
          ((1 - T + C) * Math.pow(A, 3)) / 6 +
          ((5 - 18 * T + T * T + 72 * C - 58 * ep2) * Math.pow(A, 5)) / 120);

    const northing =
      N0 +
      k0 *
        (M +
          N *
            tanLat *
            (Math.pow(A, 2) / 2 +
              ((5 - T + 9 * C + 4 * C * C) * Math.pow(A, 4)) / 24 +
              ((61 - 58 * T + T * T + 600 * C - 330 * ep2) * Math.pow(A, 6)) / 720));

    return { zone, hemisphere, easting, northing };
  }

  function convertDLTMtoWGS84(easting, northing) {
    try {
      const E = Number(easting);
      const N = Number(northing);
      if (!Number.isFinite(E) || !Number.isFinite(N)) throw new Error("Invalid input");

      // WGS84
      const a = 6378137.0;
      const invF = 298.257223563;
      const f = 1 / invF;
      const b = a * (1 - f);

      const e2 = (a * a - b * b) / (a * a);
      const ep2 = (a * a - b * b) / (b * b);

      // DLTM params
      const k0 = 1.0;
      const lon0 = degToRad(55 + 20 / 60); // 55Â°20'
      const lat0 = 0.0;
      const E0 = 500000.0;
      const N0 = 0.0;

      const dx = E - E0;
      const dy = N - N0;

      const M0 = calculateMeridionalArc(lat0, a, e2);
      const M = M0 + dy / k0;

      const mu =
        M / (a * (1 - e2 / 4 - (3 * e2 * e2) / 64 - (5 * Math.pow(e2, 3)) / 256));

      const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));

      const phi1 =
        mu +
        ((3 * e1) / 2 - (27 * Math.pow(e1, 3)) / 32) * Math.sin(2 * mu) +
        ((21 * e1 * e1) / 16 - (55 * Math.pow(e1, 4)) / 32) * Math.sin(4 * mu) +
        ((151 * Math.pow(e1, 3)) / 96) * Math.sin(6 * mu) +
        ((1097 * Math.pow(e1, 4)) / 512) * Math.sin(8 * mu);

      const sin1 = Math.sin(phi1);
      const cos1 = Math.cos(phi1);
      const tan1 = Math.tan(phi1);

      const T1 = tan1 * tan1;
      const C1 = ep2 * cos1 * cos1;

      const N1 = a / Math.sqrt(1 - e2 * sin1 * sin1);
      const R1 = (a * (1 - e2)) / Math.pow(1 - e2 * sin1 * sin1, 1.5);

      const D = dx / (N1 * k0);

      const latRad =
        phi1 -
        ((N1 * tan1) / R1) *
          ((D * D) / 2 -
            ((5 + 3 * T1 + 10 * C1 - 4 * C1 * C1 - 9 * ep2) * Math.pow(D, 4)) / 24 +
            ((61 + 90 * T1 + 298 * C1 + 45 * T1 * T1 - 3 * C1 * C1 - 252 * ep2) *
              Math.pow(D, 6)) /
              720);

      const lonRad =
        lon0 +
        (D -
          ((1 + 2 * T1 + C1) * Math.pow(D, 3)) / 6 +
          ((5 - 2 * C1 + 28 * T1 - 3 * C1 * C1 + 8 * ep2 + 24 * T1 * T1) * Math.pow(D, 5)) /
            120) /
          cos1;

      const lat = radToDeg(latRad);
      const lon = radToDeg(lonRad);
      const utm = latLonToUTM(lat, lon);

      return { success: true, latitude: lat, longitude: lon, utm };
    } catch (err) {
      return { success: false, error: String(err?.message || err) };
    }
  }

  // DMS conversion helpers
  function toDMS(value, isLon) {
    // value: decimal degrees
    const dir = isLon ? (value >= 0 ? "E" : "W") : (value >= 0 ? "N" : "S");
    const abs = Math.abs(value);

    const deg = Math.floor(abs);
    const minFloat = (abs - deg) * 60;
    const min = Math.floor(minFloat);
    const sec = (minFloat - min) * 60;

    // 3 decimals like screenshot (12.036")
    const secStr = sec.toFixed(3).padStart(6, "0"); // ensures 00.000 style if needed

    return `${deg}Â°${String(min).padStart(2, "0")}'${secStr}" ${dir}`;
  }

  function toDMSNoDir(value) {
    // If you prefer without N/E letters
    const abs = Math.abs(value);
    const deg = Math.floor(abs);
    const minFloat = (abs - deg) * 60;
    const min = Math.floor(minFloat);
    const sec = (minFloat - min) * 60;
    const secStr = sec.toFixed(3).padStart(6, "0");
    return `${deg}Â°${String(min).padStart(2, "0")}'${secStr}"`;
  }

  // ----------------------------
  // Single Conversion
  // ----------------------------
  window.runSingleDltm = function () {
    const e = parseFloat(document.getElementById("inp-e").value);
    const n = parseFloat(document.getElementById("inp-n").value);
    if (isNaN(e) || isNaN(n)) return alert("Ø£Ø¯Ø®Ù„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØµØ­ÙŠØ­Ø©");

    const btn = document.getElementById("btn-convert-single");
    btn.disabled = true;
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...";

    // Local compute (no backend)
    const res = convertDLTMtoWGS84(e, n);

    btn.disabled = false;
    btn.innerText = "ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¢Ù† âœ¨";

    if (!res.success) return alert("Ø®Ø·Ø£: " + res.error);

    // DMS output like screenshot
    document.getElementById("res-lon").innerText = toDMS(res.longitude, true);  // Longitude
    document.getElementById("res-lat").innerText = toDMS(res.latitude, false);  // Latitude
    document.getElementById("res-utm-z").innerText = String(res.utm.zone) + String(res.utm.hemisphere);
    document.getElementById("res-utm-e").innerText = Number(res.utm.easting).toFixed(3);
    document.getElementById("res-utm-n").innerText = Number(res.utm.northing).toFixed(3);
    document.getElementById("res-box-single").style.display = "block";
  };

  // ----------------------------
  // Batch Conversion (CSV/TXT)
  // Supports:
  // [E, N] or [E, N, PointID, Code]
  // ----------------------------
  let batchData = [];

  window.handleBatchFile = function (input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (ev) {
      const content = String(ev.target.result || "");
      const lines = content.split(/\r?\n/).filter((l) => l.trim());
      const rows = [];

      lines.forEach((line, i) => {
        // skip header if it contains letters
        if (i === 0 && /[a-zA-Z]/.test(line)) return;

        const parts = line.split(/[,\t;]+/).map((p) => p.trim()).filter(Boolean);
        if (parts.length < 2) return;

        const east = parseFloat(parts[0]);
        const north = parseFloat(parts[1]);
        const pId = parts.length >= 3 ? parts[2] : "";
        const code = parts.length >= 4 ? parts[3] : "";

        if (!isNaN(east) && !isNaN(north)) rows.push([east, north, pId, code]);
      });

      if (!rows.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©");

      safeShowLoader(true);

      // Local batch compute
      const results = rows.map((r) => {
        const [east, north, pId, code] = r;
        const conv = convertDLTMtoWGS84(east, north);
        if (!conv.success) return { pId, code, easting: east, northing: north, error: conv.error };
        return {
          pId,
          code,
          easting: east,
          northing: north,
          latitude: conv.latitude,
          longitude: conv.longitude,
          utmE: conv.utm.easting,
          utmN: conv.utm.northing,
          utmZone: String(conv.utm.zone) + String(conv.utm.hemisphere),
        };
      });

      safeShowLoader(false);
      batchData = results;
      renderBatchResults(results);
    };

    reader.readAsText(file);
  };

  function renderBatchResults(results) {
    const tbody = document.querySelector("#batchTable tbody");
    tbody.innerHTML = "";

    results.forEach((r) => {
      if (r.error) return;
      const tr = document.createElement("tr");
      tr.innerHTML =
        `<td>${escapeHtml(r.pId || "")}</td>` +
        `<td>${escapeHtml(r.code || "")}</td>` +
        `<td>${Number(r.easting).toFixed(2)}</td>` +
        `<td>${Number(r.northing).toFixed(2)}</td>` +
        `<td>${toDMS(r.latitude, false)}</td>` +
        `<td>${toDMS(r.longitude, true)}</td>` +
        `<td>${escapeHtml(r.utmZone)}</td>` +
        `<td>${Number(r.utmE).toFixed(2)}</td>` +
        `<td>${Number(r.utmN).toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });

    const okCount = results.filter((r) => !r.error).length;
    document.getElementById("batchCount").innerText = okCount + " Ù†Ù‚Ø§Ø· ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§";
    document.getElementById("batchResultsWrap").style.display = "block";
  }

  window.downloadBatchCsv = function () {
    if (!batchData.length) return;

    let csv = "PointID,Code,E_DLTM,N_DLTM,Latitude,Longitude,UTM_Zone,UTM_E,UTM_N\n";
    batchData.forEach((r) => {
      if (r.error) return;
      csv += `${safeCsv(r.pId)},${safeCsv(r.code)},${r.easting},${r.northing},${r.latitude},${r.longitude},${r.utmZone},${r.utmE},${r.utmN}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "DLTM_Converted.csv";
    a.click();
    URL.revokeObjectURL(url);
  };

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function safeCsv(s) {
    const v = String(s ?? "");
    if (/[",\n]/.test(v)) return `"${v.replace(/"/g, '""')}"`;
    return v;
  }
})();
</script>