<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dubai DLTM Converter - GeoTools Suite</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./vendor/leaflet/leaflet.css" />
  <script src="./vendor/leaflet/leaflet.js"></script>
  <script src="./theme.js" defer></script>
  <script src="./navbar-loader.js"></script>
  <script src="./footer-loader.js"></script>
  <script src="./keyboard-navigation.js"></script>
  <script src="./notification-system.js"></script>
</head>
<body>

<style>
  .container-dltm {
    max-width: 900px;
    width: 100%;
    margin: 0 auto;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 24px;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    color: var(--text-main);
    transition:
      background-color 0.3s ease,
      border-color 0.3s ease;
  }
  .dltm-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
    transition:
      background-color 0.3s ease,
      border-color 0.3s ease;
  }
  .dltm-tab {
    padding: 15px 30px;
    cursor: pointer;
    font-weight: 700;
    color: var(--text-muted);
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
  }
  .dltm-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    background: var(--card-bg);
  }

  .content-dltm {
    padding: 30px;
  }
  .tool-section {
    display: none;
  }
  .tool-section.active {
    display: block;
  }

  .input-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 25px;
  }
  .input-group label {
    display: block;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-main);
    font-size: 14px;
  }
  .input-group input {
    width: 100%;
    padding: 12px 15px;
    border-radius: 12px;
    border: 1px solid var(--border);
    font-size: 16px;
    outline: none;
  }

  .batch-dropzone {
    border: 2px dashed var(--border);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #f8fafc;
  }
  .batch-dropzone:hover {
    border-color: var(--primary);
    background: var(--primary-light);
  }

  .results-table-wrap {
    margin-top: 30px;
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    display: none;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  th {
    background: #f1f5f9;
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }
  td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
  }

  .btn-calc {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    background: var(--primary);
    color: #fff;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
  }
  .btn-calc:hover {
    background: var(--primary-hover);
  }

  /* Results - New Layout */
  .result-card {
    margin-top: 25px;
    background: #fff;
    padding: 18px;
    border-radius: 16px;
    border: 1px solid var(--border);
    display: none;
  }

  .result-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
  }

  .result-title {
    font-weight: 900;
    color: var(--text-main);
  }
  .result-sub {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .result-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .btn-mini {
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 800;
    cursor: pointer;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text-main);
    transition: all 0.2s;
  }
  .btn-mini:hover {
    background: var(--primary-light);
    border-color: var(--primary);
    color: var(--primary);
  }

  .result-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }

  .result-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
  }

  .result-field {
    background: #f8fafc;
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 12px;
  }

  .field-label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 800;
    margin-bottom: 6px;
  }

  .field-value {
    font-family: monospace;
    font-size: 16px;
    font-weight: 900;
    color: var(--primary);
    line-height: 1.2;
  }

  .field-hint {
    font-family: monospace;
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .result-note {
    margin-top: 12px;
    font-size: 12px;
    color: var(--text-muted);
    background: #f1f5f9;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    display: none;
  }

  @media (max-width: 720px) {
    .result-grid-2 {
      grid-template-columns: 1fr;
    }
    .result-grid-3 {
      grid-template-columns: 1fr;
    }
  }

  .field-line {
    display: flex;
    gap: 10px;
    align-items: baseline;
    margin-top: 6px;
  }

  .field-name {
    min-width: 62px;
    font-size: 12px;
    font-weight: 900;
    color: var(--text-muted);
  }

  .field-hint {
    font-family: monospace;
    font-size: 14px;
    font-weight: 800;
    color: var(--text-main);
  }

  #mapBox {
    width: 100%;
    background: white;
    border-radius: 16px;
    padding: 0;
    display: none;
  }

  #map {
    width: 100% !important;
    height: 320px !important;
    z-index: 1;
    background: #ffffff !important;
  }

  .leaflet-container {
    font-family: "Cairo", sans-serif;
    background: #ffffff !important;
    width: 100% !important;
    height: 100% !important;
  }

  /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸÖÿßÿ±ŸÉÿ± ŸàÿßŸÑŸÜŸÇÿßÿ∑ */
  .leaflet-marker-icon {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  .leaflet-marker-shadow {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
  }

  /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© */
  .leaflet-control {
    background: #fff !important;
    border-radius: 8px;
  }

  .leaflet-control-zoom-in,
  .leaflet-control-zoom-out {
    background-color: #fff !important;
    color: #333 !important;
    border: 1px solid #ccc !important;
  }

  .leaflet-control-zoom-in:hover,
  .leaflet-control-zoom-out:hover {
    background-color: #f0f0f0 !important;
  }

  /* Custom Marker Popup */
  .custom-popup .leaflet-popup-content {
    margin: 10px 0;
    padding: 10px;
    font-size: 14px;
    border-radius: 8px;
  }

  .custom-popup .leaflet-popup-tip {
    background: #fff;
    border: 1px solid #ccc;
  }
</style>

<div class="container-dltm">
  <div class="dltm-tabs">
    <div class="dltm-tab active" onclick="switchDltmTab(this, 'single')">
      Single Conversion
    </div>
    <div class="dltm-tab" onclick="switchDltmTab(this, 'batch')">
      Batch Conversion (CSV)
    </div>
    <div class="dltm-tab" onclick="switchDltmTab(this, 'reverse')">
      WGS84 ‚Üí DLTM
    </div>
  </div>

  <div class="content-dltm">
    <!-- Single Conversion -->
    <div id="section-single" class="tool-section active">
      <div class="input-grid">
        <div class="input-group">
          <label>Easting (X)</label>
          <input type="number" id="inp-e" placeholder="500000.00" />
        </div>
        <div class="input-group">
          <label>Northing (Y)</label>
          <input type="number" id="inp-n" placeholder="2768000.00" />
        </div>
      </div>

      <div
        style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px"
      >
        <div class="input-group" style="flex: 1; min-width: 220px">
          <label>Output Format</label>
          <select
            id="out-format"
            style="
              width: 100%;
              padding: 12px 15px;
              border-radius: 12px;
              border: 1px solid var(--border);
            "
          >
            <option value="dms">DMS (D¬∞M'S")</option>
            <option value="dd">Decimal Degrees</option>
            <option value="ddm">DDM (D¬∞MM.mmm')</option>
          </select>
        </div>
        <div class="input-group" style="flex: 1; min-width: 220px">
          <label>Precision</label>
          <select
            id="out-prec"
            style="
              width: 100%;
              padding: 12px 15px;
              border-radius: 12px;
              border: 1px solid var(--border);
            "
          >
            <option value="8">Decimal: 8</option>
            <option value="6">Decimal: 6</option>
            <option value="4">Decimal: 4</option>
          </select>
        </div>
        <button
          class="btn-nav-top"
          title="ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©"
          onclick="clearLastInputs()"
        >
          üóëÔ∏è ŸÖÿ≥ÿ≠
        </button>
      </div>
      <button
        class="btn-calc"
        id="btn-convert-single"
        onclick="runSingleDltm()"
      >
        ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ¢ŸÜ ‚ú®
      </button>

      <div id="res-box-single" class="result-card">
        <div class="result-head">
          <div>
            <div class="result-title">Output coordinates</div>
            <div class="result-sub">Format: D¬∞M'S"</div>
          </div>

          <div class="result-actions">
            <button class="btn-mini" onclick="copySingle('dms')">
              Copy DMS
            </button>
            <button class="btn-mini" onclick="copySingle('dd')">
              Copy Decimal
            </button>
            <button class="btn-mini" onclick="copySingle('utm')">
              Copy UTM
            </button>
          </div>
        </div>

        <div class="result-grid-2">
          <div class="result-field">
            <div class="field-label">Longitude</div>

            <div class="field-line">
              <span class="field-name">DMS:</span>
              <span class="field-value" id="res-lon-dms">-</span>
            </div>

            <div class="field-line">
              <span class="field-name">Decimal:</span>
              <span class="field-hint" id="res-lon-dd">-</span>
            </div>
          </div>

          <div class="result-field">
            <div class="field-label">Latitude</div>

            <div class="field-line">
              <span class="field-name">DMS:</span>
              <span class="field-value" id="res-lat-dms">-</span>
            </div>

            <div class="field-line">
              <span class="field-name">Decimal:</span>
              <span class="field-hint" id="res-lat-dd">-</span>
            </div>
          </div>
        </div>

        <div class="result-grid-3">
          <div class="result-field">
            <div class="field-label">UTM Zone</div>
            <div class="field-value" id="res-utm-z">-</div>
          </div>

          <div class="result-field">
            <div class="field-label">UTM Easting</div>
            <div class="field-value" id="res-utm-e">-</div>
          </div>

          <div class="result-field">
            <div class="field-label">UTM Northing</div>
            <div class="field-value" id="res-utm-n">-</div>
          </div>
        </div>

        <div class="result-note" id="res-note"></div>
      </div>

      <div id="mapBox" style="margin-top: 14px; display: none">
        <div
          style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px"
        >
          <button class="btn-nav-top" onclick="openGoogleMapsLink()">
            üåç Open in Google Maps
          </button>
          <button class="btn-nav-top" onclick="downloadSingleKml()">
            Save KML
          </button>
        </div>
        <div
          id="map"
          style="
            height: 320px;
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
          "
        ></div>
      </div>
    </div>

    <!-- Batch Conversion -->
    <div id="section-batch" class="tool-section">
      <div style="margin-bottom: 14px">
        <label style="display: block; font-weight: 900; margin-bottom: 8px"
          >Choose Batch Conversion Type:</label
        >
        <div style="display: flex; gap: 10px; margin-bottom: 12px">
          <label
            style="
              display: flex;
              align-items: center;
              gap: 6px;
              cursor: pointer;
            "
          >
            <input
              type="radio"
              name="batch-direction"
              value="dltm-to-wgs"
              checked
              onchange="switchBatchDirection('dltm-to-wgs')"
            />
            DLTM ‚Üí WGS84
          </label>
          <label
            style="
              display: flex;
              align-items: center;
              gap: 6px;
              cursor: pointer;
            "
          >
            <input
              type="radio"
              name="batch-direction"
              value="wgs-to-dltm"
              onchange="switchBatchDirection('wgs-to-dltm')"
            />
            WGS84 ‚Üí DLTM
          </label>
        </div>
      </div>

      <div style="margin-bottom: 14px">
        <label style="display: block; font-weight: 900; margin-bottom: 8px"
          >Paste Coordinates (instead of uploading file)</label
        >
        <textarea
          id="batchPaste"
          rows="8"
          placeholder="Example:
489817.908,2768047.013
489790.938,2768033.067
Or with commas/spaces/Tab"
          style="
            width: 100%;
            padding: 12px;
            border-radius: 14px;
            border: 1px solid var(--border);
            font-family: monospace;
          "
        ></textarea>

        <div
          style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px"
        >
          <button class="btn-nav-top" onclick="runBatchFromPaste()">
            Convert Paste
          </button>
          <button
            class="btn-nav-top"
            onclick="document.getElementById('batchPaste').value = ''"
          >
            Clear
          </button>

          <div
            style="
              margin-left: auto;
              display: flex;
              gap: 10px;
              align-items: center;
            "
          >
            <label style="font-weight: 900; color: var(--text-muted)"
              >Export:</label
            >
            <select
              id="batchExportType"
              style="
                padding: 10px 12px;
                border-radius: 12px;
                border: 1px solid var(--border);
              "
            >
              <option value="csv">CSV</option>
              <option value="kml">KML</option>
              <option value="geojson">GeoJSON</option>
            </select>
          </div>
        </div>
      </div>
      <div
        class="batch-dropzone"
        onclick="document.getElementById('batchFile').click()"
      >
        <span style="font-size: 40px">üìÑ</span>
        <h3 style="margin: 10px 0">Click to Upload CSV File</h3>
        <p style="font-size: 13px; color: var(--text-muted)">
          File must contain columns (E, N) and optionally (PointID, Code)
        </p>
        <input
          type="file"
          id="batchFile"
          style="display: none"
          accept=".csv,.txt"
          onchange="handleBatchFile(this)"
        />
      </div>

      <div class="results-table-wrap" id="batchResultsWrap">
        <div
          style="
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <strong id="batchCount">0 points converted</strong>
          <button class="btn-nav-top" onclick="downloadBatch()">
            Download üíæ
          </button>
        </div>
        <div style="max-height: 400px; overflow-y: auto">
          <table id="batchTable">
            <thead>
              <tr>
                <th>POINT</th>
                <th>ID</th>
                <th>N_DLTM</th>
                <th>E_DLTM</th>
                <th>Z_DLTM</th>
                <th>Code</th>
                <th>ÿπÿßŸÖŸàÿØ</th>
                <th>ŸÅÿßÿ±ÿ∫</th>
                <th>UTM_N</th>
                <th>UTM_E</th>
                <th>UTM_Z</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>altitude</th>
                <th>code</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Reverse Conversion (WGS84 ‚Üí DLTM) -->
    <div id="section-reverse" class="tool-section">
      <div style="margin-bottom: 12px">
        <label style="display: block; font-weight: 900; margin-bottom: 8px"
          >Choose Input Type:</label
        >
        <div style="display: flex; gap: 10px; margin-bottom: 12px">
          <label
            style="
              display: flex;
              align-items: center;
              gap: 6px;
              cursor: pointer;
            "
          >
            <input
              type="radio"
              name="rev-input-type"
              value="wgs84"
              checked
              onchange="switchReverseInputType('wgs84')"
            />
            WGS84 (Lat/Lon)
          </label>
          <label
            style="
              display: flex;
              align-items: center;
              gap: 6px;
              cursor: pointer;
            "
          >
            <input
              type="radio"
              name="rev-input-type"
              value="utm"
              onchange="switchReverseInputType('utm')"
            />
            UTM
          </label>
        </div>
      </div>

      <!-- WGS84 Input -->
      <div id="wgs84-inputs" class="input-grid">
        <div class="input-group">
          <label>Longitude</label>
          <input type="number" id="inp-lon" placeholder="55.123456" />
        </div>
        <div class="input-group">
          <label>Latitude</label>
          <input type="number" id="inp-lat" placeholder="25.123456" />
        </div>
      </div>

      <!-- UTM Input (ŸÖÿÆŸÅŸä ÿ®ÿ¥ŸÉŸÑ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä) -->
      <div id="utm-inputs" class="input-grid" style="display: none">
        <div class="input-group">
          <label>UTM Zone</label>
          <input
            type="text"
            id="inp-utm-zone"
            placeholder="40N"
            maxlength="3"
          />
        </div>
        <div class="input-group">
          <label>Easting (meters)</label>
          <input
            type="number"
            id="inp-utm-e"
            placeholder="500000"
            step="0.01"
          />
        </div>
        <div class="input-group">
          <label>Northing (meters)</label>
          <input
            type="number"
            id="inp-utm-n"
            placeholder="2768000"
            step="0.01"
          />
        </div>
      </div>

      <div
        style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px"
      >
        <button class="btn-calc" style="flex: 1" onclick="runReverseDltm()">
          ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ¢ŸÜ ‚ú®
        </button>
        <button class="btn-nav-top" onclick="showOnMapFromWgs()">
          Show on Map
        </button>
        <button
          class="btn-nav-top"
          title="ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©"
          onclick="clearLastInputs()"
        >
          üóëÔ∏è ŸÖÿ≥ÿ≠
        </button>
      </div>

      <div id="reverse-box" class="result-card">
        <div class="result-head">
          <div>
            <div class="result-title">DLTM Output</div>
            <div class="result-sub">TM (Dubai Local) ‚Äì meters</div>
          </div>
          <div class="result-actions">
            <button class="btn-mini" onclick="copyReverse('dltm')">
              Copy DLTM
            </button>
            <button class="btn-mini" onclick="copyReverse('wgs')">
              Copy WGS84
            </button>
          </div>
        </div>

        <div class="result-grid-2">
          <div class="result-field">
            <div class="field-label">Easting (DLTM)</div>
            <div class="field-line">
              <span class="field-name">E:</span
              ><span class="field-value" id="res-dltm-e">-</span>
            </div>
          </div>
          <div class="result-field">
            <div class="field-label">Northing (DLTM)</div>
            <div class="field-line">
              <span class="field-name">N:</span
              ><span class="field-value" id="res-dltm-n">-</span>
            </div>
          </div>
        </div>

        <div class="result-note" id="reverse-note"></div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    // ----------------------------
    // Minimal Loader Fallback
    // (Index.html ÿπŸÜÿØŸÉ ŸÅŸäŸá showLoader ÿ®ÿßŸÑŸÅÿπŸÑ)
    // ----------------------------
    function safeShowLoader(show) {
      try {
        if (typeof showLoader === "function") return showLoader(show);
      } catch {}
      // fallback: no-op
    }

    // ----------------------------
    // Local Storage for Last Inputs
    // ----------------------------
    function saveLastInputs() {
      const e = document.getElementById("inp-e").value;
      const n = document.getElementById("inp-n").value;
      const lon = document.getElementById("inp-lon").value;
      const lat = document.getElementById("inp-lat").value;
      const format = document.getElementById("out-format").value;
      const precision = document.getElementById("out-prec").value;

      localStorage.setItem("dltm_lastE", e);
      localStorage.setItem("dltm_lastN", n);
      localStorage.setItem("dltm_lastLon", lon);
      localStorage.setItem("dltm_lastLat", lat);
      localStorage.setItem("dltm_lastFormat", format);
      localStorage.setItem("dltm_lastPrecision", precision);
    }

    function loadLastInputs() {
      const e = localStorage.getItem("dltm_lastE");
      const n = localStorage.getItem("dltm_lastN");
      const lon = localStorage.getItem("dltm_lastLon");
      const lat = localStorage.getItem("dltm_lastLat");
      const format = localStorage.getItem("dltm_lastFormat") || "dms";
      const precision = localStorage.getItem("dltm_lastPrecision") || "8";

      if (e) document.getElementById("inp-e").value = e;
      if (n) document.getElementById("inp-n").value = n;
      if (lon) document.getElementById("inp-lon").value = lon;
      if (lat) document.getElementById("inp-lat").value = lat;
      document.getElementById("out-format").value = format;
      document.getElementById("out-prec").value = precision;
    }

    function clearLastInputs() {
      localStorage.removeItem("dltm_lastE");
      localStorage.removeItem("dltm_lastN");
      localStorage.removeItem("dltm_lastLon");
      localStorage.removeItem("dltm_lastLat");
      localStorage.removeItem("dltm_lastFormat");
      localStorage.removeItem("dltm_lastPrecision");
    }

    // ----------------------------
    // Tabs
    // ----------------------------
    window.switchDltmTab = function (el, tab) {
      document
        .querySelectorAll(".dltm-tab")
        .forEach((t) => t.classList.remove("active"));
      document
        .querySelectorAll(".tool-section")
        .forEach((s) => s.classList.remove("active"));
      el.classList.add("active");
      document.getElementById("section-" + tab).classList.add("active");
    };

    window.switchBatchDirection = function (dir) {
      const textarea = document.getElementById("batchPaste");
      if (dir === "wgs-to-dltm") {
        textarea.placeholder =
          "WGS84 Example:\n55.123456,25.123456\n55.234567,25.234567\nOr with commas/spaces/Tab";
      } else {
        textarea.placeholder =
          "DLTM Example:\n489817.908,2768047.013\n489790.938,2768033.067\nOr with commas/spaces/Tab";
      }
    };

    // ----------------------------
    // Core Math (Ported from DLTM_Utils.gs)
    // Parameters from your screenshot:
    // - WGS84 ellipsoid
    // - TM: lon0 = 55¬∞20'00"E, k0=1.0, FE=500000, FN=0
    // ----------------------------
    function degToRad(deg) {
      return (deg * Math.PI) / 180;
    }
    function radToDeg(rad) {
      return (rad * 180) / Math.PI;
    }

    function calculateMeridionalArc(phi, a, e2) {
      return (
        a *
        ((1 - e2 / 4 - (3 * e2 * e2) / 64 - (5 * Math.pow(e2, 3)) / 256) * phi -
          ((3 * e2) / 8 + (3 * e2 * e2) / 32 + (45 * Math.pow(e2, 3)) / 1024) *
            Math.sin(2 * phi) +
          ((15 * e2 * e2) / 256 + (45 * Math.pow(e2, 3)) / 1024) *
            Math.sin(4 * phi) -
          ((35 * Math.pow(e2, 3)) / 3072) * Math.sin(6 * phi))
      );
    }

    function latLonToUTM(latDeg, lonDeg) {
      // WGS84
      const a = 6378137.0;
      const invF = 298.257223563;
      const f = 1 / invF;
      const b = a * (1 - f);

      const e2 = (a * a - b * b) / (a * a);
      const ep2 = (a * a - b * b) / (b * b);

      const lat = degToRad(latDeg);
      const lon = degToRad(lonDeg);

      let zone = Math.floor((lonDeg + 180) / 6) + 1;
      if (zone < 1) zone = 1;
      if (zone > 60) zone = 60;

      const hemisphere = latDeg >= 0 ? "N" : "S";
      const lon0Deg = (zone - 1) * 6 - 180 + 3;
      const lon0 = degToRad(lon0Deg);

      const k0 = 0.9996;
      const E0 = 500000.0;
      const N0 = hemisphere === "S" ? 10000000.0 : 0.0;

      const sinLat = Math.sin(lat);
      const cosLat = Math.cos(lat);
      const tanLat = Math.tan(lat);

      const N = a / Math.sqrt(1 - e2 * sinLat * sinLat);
      const T = tanLat * tanLat;
      const C = ep2 * cosLat * cosLat;
      const A = (lon - lon0) * cosLat;

      const M = calculateMeridionalArc(lat, a, e2);

      const easting =
        E0 +
        k0 *
          N *
          (A +
            ((1 - T + C) * Math.pow(A, 3)) / 6 +
            ((5 - 18 * T + T * T + 72 * C - 58 * ep2) * Math.pow(A, 5)) / 120);

      const northing =
        N0 +
        k0 *
          (M +
            N *
              tanLat *
              (Math.pow(A, 2) / 2 +
                ((5 - T + 9 * C + 4 * C * C) * Math.pow(A, 4)) / 24 +
                ((61 - 58 * T + T * T + 600 * C - 330 * ep2) * Math.pow(A, 6)) /
                  720));

      return { zone, hemisphere, easting, northing };
    }

    function convertDLTMtoWGS84(easting, northing) {
      try {
        const E = Number(easting);
        const N = Number(northing);
        if (!Number.isFinite(E) || !Number.isFinite(N))
          throw new Error("Invalid input");

        // WGS84
        const a = 6378137.0;
        const invF = 298.257223563;
        const f = 1 / invF;
        const b = a * (1 - f);

        const e2 = (a * a - b * b) / (a * a);
        const ep2 = (a * a - b * b) / (b * b);

        // DLTM params
        const k0 = 1.0;
        const lon0 = degToRad(55 + 20 / 60); // 55¬∞20'
        const lat0 = 0.0;
        const E0 = 500000.0;
        const N0 = 0.0;

        const dx = E - E0;
        const dy = N - N0;

        const M0 = calculateMeridionalArc(lat0, a, e2);
        const M = M0 + dy / k0;

        const mu =
          M /
          (a * (1 - e2 / 4 - (3 * e2 * e2) / 64 - (5 * Math.pow(e2, 3)) / 256));

        const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));

        const phi1 =
          mu +
          ((3 * e1) / 2 - (27 * Math.pow(e1, 3)) / 32) * Math.sin(2 * mu) +
          ((21 * e1 * e1) / 16 - (55 * Math.pow(e1, 4)) / 32) *
            Math.sin(4 * mu) +
          ((151 * Math.pow(e1, 3)) / 96) * Math.sin(6 * mu) +
          ((1097 * Math.pow(e1, 4)) / 512) * Math.sin(8 * mu);

        const sin1 = Math.sin(phi1);
        const cos1 = Math.cos(phi1);
        const tan1 = Math.tan(phi1);

        const T1 = tan1 * tan1;
        const C1 = ep2 * cos1 * cos1;

        const N1 = a / Math.sqrt(1 - e2 * sin1 * sin1);
        const R1 = (a * (1 - e2)) / Math.pow(1 - e2 * sin1 * sin1, 1.5);

        const D = dx / (N1 * k0);

        const latRad =
          phi1 -
          ((N1 * tan1) / R1) *
            ((D * D) / 2 -
              ((5 + 3 * T1 + 10 * C1 - 4 * C1 * C1 - 9 * ep2) *
                Math.pow(D, 4)) /
                24 +
              ((61 +
                90 * T1 +
                298 * C1 +
                45 * T1 * T1 -
                3 * C1 * C1 -
                252 * ep2) *
                Math.pow(D, 6)) /
                720);

        const lonRad =
          lon0 +
          (D -
            ((1 + 2 * T1 + C1) * Math.pow(D, 3)) / 6 +
            ((5 - 2 * C1 + 28 * T1 - 3 * C1 * C1 + 8 * ep2 + 24 * T1 * T1) *
              Math.pow(D, 5)) /
              120) /
            cos1;

        const lat = radToDeg(latRad);
        const lon = radToDeg(lonRad);
        const utm = latLonToUTM(lat, lon);

        return { success: true, latitude: lat, longitude: lon, utm };
      } catch (err) {
        return { success: false, error: String(err?.message || err) };
      }
    }

    // DMS conversion helpers
    function toDMS(value, isLon) {
      // value: decimal degrees
      const dir = isLon ? (value >= 0 ? "E" : "W") : value >= 0 ? "N" : "S";
      const abs = Math.abs(value);

      const deg = Math.floor(abs);
      const minFloat = (abs - deg) * 60;
      const min = Math.floor(minFloat);
      const sec = (minFloat - min) * 60;

      // 3 decimals like screenshot (12.036")
      const secStr = sec.toFixed(3).padStart(6, "0"); // ensures 00.000 style if needed

      return `${deg}¬∞${String(min).padStart(2, "0")}'${secStr}" ${dir}`;
    }

    function toDMSNoDir(value) {
      // If you prefer without N/E letters
      const abs = Math.abs(value);
      const deg = Math.floor(abs);
      const minFloat = (abs - deg) * 60;
      const min = Math.floor(minFloat);
      const sec = (minFloat - min) * 60;
      const secStr = sec.toFixed(3).padStart(6, "0");
      return `${deg}¬∞${String(min).padStart(2, "0")}'${secStr}"`;
    }

    function toDDM(value, isLon) {
      const dir = isLon ? (value >= 0 ? "E" : "W") : value >= 0 ? "N" : "S";
      const abs = Math.abs(value);
      const deg = Math.floor(abs);
      const minutes = (abs - deg) * 60;
      return `${deg}¬∞${minutes.toFixed(3).padStart(6, "0")}' ${dir}`;
    }

    function formatCoord(value, isLon) {
      const fmt = document.getElementById("out-format")?.value || "dms";
      const prec = Number(document.getElementById("out-prec")?.value || 8);
      if (fmt === "dd")
        return `${value.toFixed(prec)} ${isLon ? (value >= 0 ? "E" : "W") : value >= 0 ? "N" : "S"}`;
      if (fmt === "ddm") return toDDM(value, isLon);
      return toDMS(value, isLon);
    }

    function validateAndMaybeSwap(E, N) {
      const E_ok = E > 200000 && E < 900000;
      const N_ok = N > 2000000 && N < 4000000;
      const swapLikely =
        !E_ok &&
        !N_ok &&
        N > 200000 &&
        N < 900000 &&
        E > 2000000 &&
        E < 4000000;
      if (swapLikely)
        return {
          E: N,
          N: E,
          swapped: true,
          warn: "Ÿäÿ®ÿØŸà ÿ£ŸÜ East/North ŸÖŸÇŸÑŸàÿ®ŸäŸÜÿå ÿ™ŸÖ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß.",
        };
      const warn =
        !E_ok || !N_ok
          ? "ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÜÿ∑ÿßŸÇ ÿßŸÑŸÖÿ™ŸàŸÇÿπ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ/ÿßŸÑŸÇŸäŸÖ."
          : "";
      return { E, N, swapped: false, warn };
    }

    function convertWGS84toDLTM(latDeg, lonDeg) {
      try {
        const lat = Number(latDeg),
          lon = Number(lonDeg);
        if (!Number.isFinite(lat) || !Number.isFinite(lon))
          throw new Error("Invalid input");
        const a = 6378137.0;
        const invF = 298.257223563;
        const f = 1 / invF;
        const b = a * (1 - f);
        const e2 = (a * a - b * b) / (a * a);
        const ep2 = (a * a - b * b) / (b * b);
        const k0 = 1.0;
        const lon0 = degToRad(55 + 20 / 60);
        const lat0 = 0.0;
        const E0 = 500000.0;
        const N0 = 0.0;
        const phi = degToRad(lat);
        const lam = degToRad(lon);
        const sinPhi = Math.sin(phi);
        const cosPhi = Math.cos(phi);
        const tanPhi = Math.tan(phi);
        const N = a / Math.sqrt(1 - e2 * sinPhi * sinPhi);
        const T = tanPhi * tanPhi;
        const C = ep2 * cosPhi * cosPhi;
        const A = (lam - lon0) * cosPhi;
        const M = calculateMeridionalArc(phi, a, e2);
        const M0 = calculateMeridionalArc(lat0, a, e2);
        const East =
          E0 +
          k0 *
            N *
            (A +
              ((1 - T + C) * Math.pow(A, 3)) / 6 +
              ((5 - 18 * T + T * T + 72 * C - 58 * ep2) * Math.pow(A, 5)) /
                120);
        const North =
          N0 +
          k0 *
            (M -
              M0 +
              N *
                tanPhi *
                (Math.pow(A, 2) / 2 +
                  ((5 - T + 9 * C + 4 * C * C) * Math.pow(A, 4)) / 24 +
                  ((61 - 58 * T + T * T + 600 * C - 330 * ep2) *
                    Math.pow(A, 6)) /
                    720));
        return { success: true, easting: East, northing: North };
      } catch (err) {
        return { success: false, error: String(err?.message || err) };
      }
    }

    // ----------------------------
    // Single Conversion
    // ----------------------------
    window.runSingleDltm = function () {
      const e = parseFloat(document.getElementById("inp-e").value);
      const n = parseFloat(document.getElementById("inp-n").value);
      if (isNaN(e) || isNaN(n)) return alert("ÿ£ÿØÿÆŸÑ ÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ©");

      saveLastInputs();

      const btn = document.getElementById("btn-convert-single");
      btn.disabled = true;
      btn.innerText = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ...";

      // Local compute (no backend)
      const v = validateAndMaybeSwap(e, n);
      const res = convertDLTMtoWGS84(v.E, v.N);

      btn.disabled = false;
      btn.innerText = "ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ¢ŸÜ ‚ú®";

      if (!res.success) return alert("Error: " + res.error);

      // Longitude/Latitude (formatCoord changes based on selection)
      document.getElementById("res-lon-dms").innerText = formatCoord(
        res.longitude,
        true,
      );
      document.getElementById("res-lat-dms").innerText = formatCoord(
        res.latitude,
        false,
      );

      document.getElementById("res-lon-dd").innerText =
        res.longitude.toFixed(8);
      document.getElementById("res-lat-dd").innerText = res.latitude.toFixed(8);

      // UTM
      document.getElementById("res-utm-z").innerText =
        String(res.utm.zone) + String(res.utm.hemisphere);
      document.getElementById("res-utm-e").innerText = Number(
        res.utm.easting,
      ).toFixed(3);
      document.getElementById("res-utm-n").innerText = Number(
        res.utm.northing,
      ).toFixed(3);

      if (v.warn) {
        const note = document.getElementById("res-note");
        if (note) {
          note.style.display = "block";
          note.innerText = v.warn;
        }
      }

      document.getElementById("res-box-single").style.display = "block";
      showPointOnMap(res.latitude, res.longitude);
    };

    // ----------------------------
    // Batch Conversion (CSV/TXT)
    // Supports:
    // [E, N] or [E, N, PointID, Code]
    // ----------------------------
    let batchData = [];

    window.handleBatchFile = function (input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (ev) {
        const content = String(ev.target.result || "");
        const lines = content.split(/\r?\n/).filter((l) => l.trim());
        const rows = [];

        lines.forEach((line, i) => {
          if (i === 0 && /[a-zA-Z]/.test(line)) return; // Skip header
          const parts = line
            .split(/[,\t;]+/)
            .map((p) => p.trim())
            .filter(Boolean);
          if (parts.length < 2) return;

          // Identify columns by digit count: N has 7 digits, E has 6 digits
          let pointId = null,
            northing = null,
            easting = null,
            zValue = null,
            code = null;

          for (let j = 0; j < parts.length; j++) {
            const val = parts[j];
            const integerPart = val.split(".")[0];
            const integerDigits = integerPart.replace(/[^0-9]/g, "").length;
            const isNumeric = !isNaN(parseFloat(val)) && isFinite(val);

            // Identify by digit count first
            if (isNumeric && integerDigits === 7 && northing === null) {
              northing = parseFloat(val);
            } else if (isNumeric && integerDigits === 6 && easting === null) {
              easting = parseFloat(val);
            } else if (
              isNumeric &&
              integerDigits <= 4 &&
              northing !== null &&
              easting !== null &&
              zValue === null
            ) {
              // Small number after N,E = Z value
              zValue = parseFloat(val);
            } else if (!isNumeric && pointId === null) {
              // Text = Point ID
              pointId = val;
            } else if (isNumeric && integerDigits <= 2 && pointId === null) {
              // Small number first = Point ID
              pointId = String(val);
            } else if (!isNumeric && code === null && pointId !== null) {
              // Text after others = Code
              code = val;
            }
          }

          if (northing !== null && easting !== null) {
            rows.push({
              pointId: pointId || "",
              northing,
              easting,
              zValue: zValue || 0,
              code: code || "",
            });
          }
        });

        if (!rows.length) return alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿµÿßŸÑÿ≠ÿ©");
        safeShowLoader(true);

        // Convert DLTM to WGS84 and then to UTM Zone 40N
        const results = rows.map((r) => {
          const conv = convertDLTMtoWGS84(r.easting, r.northing);

          if (!conv.success) {
            return {
              error: conv.error,
              pointId: r.pointId,
            };
          }

          // Convert to UTM Zone 40N
          const utm40 = convertWGS84toUTMZone40N(conv.latitude, conv.longitude);

          return {
            pointId: r.pointId,
            nDltm: r.northing,
            eDltm: r.easting,
            zDltm: r.zValue,
            code: r.code,
            latitude: conv.latitude,
            longitude: conv.longitude,
            utmN: utm40.northing,
            utmE: utm40.easting,
            utmZone: "40N",
            altitude: r.zValue || "",
          };
        });

        safeShowLoader(false);
        batchData = results;
        renderBatchResults(results);
      };

      reader.readAsText(file);
    };

    // Helper function to convert WGS84 to UTM Zone 40N
    function convertWGS84toUTMZone40N(lat, lon) {
      const zone = 40;
      const lonOrigin = (zone - 0.5) * 6 - 180; // Central meridian for zone 40
      const a = 6378137.0; // WGS84 semi-major axis
      const b = 6356752.314245; // WGS84 semi-minor axis
      const f = 1 / 298.257223563; // WGS84 flattening
      const k0 = 0.9996; // UTM scale factor
      const e2 = f * (2 - f);
      const e4 = e2 * e2;
      const e6 = e4 * e2;

      const latRad = (lat * Math.PI) / 180;
      const lonRad = (lon * Math.PI) / 180;
      const lonOriginRad = (lonOrigin * Math.PI) / 180;

      const N = a / Math.sqrt(1 - e2 * Math.sin(latRad) * Math.sin(latRad));
      const T = Math.tan(latRad) * Math.tan(latRad);
      const C = (e2 / (1 - e2)) * Math.cos(latRad) * Math.cos(latRad);
      const A = Math.cos(latRad) * (lonRad - lonOriginRad);
      const M =
        a *
        ((1 - e2 / 4 - (3 * e4) / 64 - (5 * e6) / 256) * latRad -
          ((3 * e2) / 8 + (3 * e4) / 32 - (45 * e6) / 1024) *
            Math.sin(2 * latRad) +
          ((15 * e4) / 256 - (45 * e6) / 1024) * Math.sin(4 * latRad) -
          ((35 * e6) / 3072) * Math.sin(6 * latRad));

      const easting =
        k0 *
          N *
          (A +
            ((A * A * A) / 6) * (1 - T + C) +
            (Math.pow(A, 5) / 120) * (1 - 5 * T + 9 * C + 4 * C * C)) +
        500000;
      const northing =
        k0 *
        (M +
          N *
            Math.tan(latRad) *
            ((A * A) / 2 +
              (Math.pow(A, 4) / 24) * (5 - T + 9 * C + 4 * C * C) +
              (Math.pow(A, 6) / 720) *
                (61 - 58 * T + T * T + 600 * C - 330 * e2)));

      return { easting, northing };
    }

    function renderBatchResults(results) {
      const tbody = document.querySelector("#batchTable tbody");
      tbody.innerHTML = "";

      results.forEach((r) => {
        if (r.error) return;
        const tr = document.createElement("tr");

        // Format numbers safely
        const formatNum = (val, decimals) => {
          if (val === null || val === undefined || val === "") return "";
          const num = Number(val);
          return isFinite(num) ? num.toFixed(decimals) : "";
        };

        tr.innerHTML =
          `<td>${escapeHtml(r.pointId || "")}</td>` +
          `<td>${escapeHtml(r.pointId || "")}</td>` +
          `<td>${formatNum(r.nDltm, 2)}</td>` +
          `<td>${formatNum(r.eDltm, 2)}</td>` +
          `<td>${formatNum(r.zDltm, 2)}</td>` +
          `<td>${escapeHtml(r.code || "")}</td>` +
          `<td></td>` +
          `<td></td>` +
          `<td>${formatNum(r.utmN, 2)}</td>` +
          `<td>${formatNum(r.utmE, 2)}</td>` +
          `<td>${r.utmZone || "40N"}</td>` +
          `<td>${formatNum(r.latitude, 6)}</td>` +
          `<td>${formatNum(r.longitude, 6)}</td>` +
          `<td>${formatNum(r.altitude, 2)}</td>` +
          `<td>${escapeHtml(r.code || "")}</td>`;

        // Click to show on map
        tr.style.cursor = "pointer";
        tr.addEventListener("click", () =>
          showPointOnMap(r.latitude, r.longitude),
        );

        tbody.appendChild(tr);
      });

      const okCount = results.filter((r) => !r.error).length;
      document.getElementById("batchCount").innerText =
        okCount + " ŸÜŸÇÿßÿ∑ ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑŸáÿß";
      document.getElementById("batchResultsWrap").style.display = "block";
    }

    window.downloadBatchCsv = function () {
      if (!batchData.length) return;
      let csv =
        "POINT,ID,N_DLTM,E_DLTM,Z_DLTM,Code,ÿπÿßŸÖŸàÿØ,ŸÅÿßÿ±ÿ∫,UTM_N,UTM_E,UTM_Z,Latitude,Longitude,altitude,code\n";
      let filename = "DLTM_to_UTM_Zone40N.csv";

      batchData.forEach((r) => {
        if (r.error) return;
        csv += `${safeCsv(r.pointId)},${safeCsv(r.pointId)},${r.nDltm},${r.eDltm},${r.zDltm},${safeCsv(r.code)},,,${r.utmN},${r.utmE},${r.utmZone},${r.latitude},${r.longitude},${r.altitude},${safeCsv(r.code)}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    };

    window.runBatchFromPaste = function () {
      const text = (document.getElementById("batchPaste").value || "").trim();
      if (!text) return alert("ÿßŸÑÿµŸÇ ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ ÿ£ŸàŸÑÿßŸã");
      const direction =
        document.querySelector("input[name='batch-direction']:checked")
          ?.value || "dltm-to-wgs";

      const lines = text
        .split(/\r?\n/)
        .map((l) => l.trim())
        .filter(Boolean);
      const rows = [];
      for (const line of lines) {
        const parts = line
          .split(/[,\t; ]+/)
          .map((p) => p.trim())
          .filter(Boolean);
        if (parts.length < 2) continue;
        const val1 = parseFloat(parts[0]);
        const val2 = parseFloat(parts[1]);
        const pId = parts.length >= 3 ? parts[2] : "";
        const code = parts.length >= 4 ? parts[3] : "";
        if (Number.isFinite(val1) && Number.isFinite(val2))
          rows.push([val1, val2, pId, code]);
      }
      if (!rows.length) return alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸÅŸàŸÅ ÿµÿßŸÑÿ≠ÿ©");
      safeShowLoader(true);

      let results;
      if (direction === "wgs-to-dltm") {
        results = rows.map(([lon, lat, pId, code]) => {
          const conv = convertWGS84toDLTM(lat, lon);
          if (!conv.success)
            return {
              pId,
              code,
              longitude: lon,
              latitude: lat,
              error: conv.error,
            };
          const utm = latLonToUTM(lat, lon);
          return {
            pId,
            code,
            easting: conv.easting,
            northing: conv.northing,
            latitude: lat,
            longitude: lon,
            utmE: utm.easting,
            utmN: utm.northing,
            utmZone: String(utm.zone) + String(utm.hemisphere),
          };
        });
      } else {
        results = rows.map(([east, north, pId, code]) => {
          const v = validateAndMaybeSwap(east, north);
          const conv = convertDLTMtoWGS84(v.E, v.N);
          if (!conv.success)
            return {
              pId,
              code,
              easting: east,
              northing: north,
              error: conv.error,
            };
          return {
            pId,
            code,
            easting: east,
            northing: north,
            latitude: conv.latitude,
            longitude: conv.longitude,
            utmE: conv.utm.easting,
            utmN: conv.utm.northing,
            utmZone: String(conv.utm.zone) + String(conv.utm.hemisphere),
          };
        });
      }

      safeShowLoader(false);
      batchData = results;
      renderBatchResults(results);
    };

    window.downloadBatch = function () {
      const t = document.getElementById("batchExportType")?.value || "csv";
      if (t === "kml") return downloadBatchKml();
      if (t === "geojson") return downloadBatchGeoJson();
      return downloadBatchCsv();
    };

    function downloadBatchKml() {
      const ok = batchData.filter((r) => !r.error);
      if (!ok.length) return alert("No data to export");
      const direction =
        document.querySelector("input[name='batch-direction']:checked")
          ?.value || "dltm-to-wgs";
      const filename =
        direction === "wgs-to-dltm" ? "WGS84_to_DLTM.kml" : "DLTM_to_WGS84.kml";
      const placemarks = ok
        .map(
          (r, i) => `
    <Placemark>
      <name>${r.pId || "P" + (i + 1)}</name>
      <description>${r.code || ""}</description>
      <Point><coordinates>${r.longitude},${r.latitude},0</coordinates></Point>
    </Placemark>`,
        )
        .join("\n");
      const kml = `<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>${placemarks}
  </Document>
  </kml>`;
      const blob = new Blob([kml], {
        type: "application/vnd.google-earth.kml+xml;charset=utf-8",
      });
      const u = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = u;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(u);
    }

    function downloadBatchGeoJson() {
      const ok = batchData.filter((r) => !r.error);
      if (!ok.length) return alert("No data to export");
      const direction =
        document.querySelector("input[name='batch-direction']:checked")
          ?.value || "dltm-to-wgs";
      const filename =
        direction === "wgs-to-dltm"
          ? "WGS84_to_DLTM.geojson"
          : "DLTM_to_WGS84.geojson";
      const geo = {
        type: "FeatureCollection",
        features: ok.map((r, i) => ({
          type: "Feature",
          properties: {
            point: r.pId || "P" + (i + 1),
            code: r.code || "",
            e_dltm: r.easting,
            n_dltm: r.northing,
            utm_zone: r.utmZone,
            utm_e: r.utmE,
            utm_n: r.utmN,
          },
          geometry: { type: "Point", coordinates: [r.longitude, r.latitude] },
        })),
      };
      const blob = new Blob([JSON.stringify(geo, null, 2)], {
        type: "application/geo+json;charset=utf-8",
      });
      const u = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = u;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(u);
    }

    let _map = null;
    let _marker = null;
    let _lastLatLon = null;

    function destroyMapIfAny() {
      try {
        if (_map) {
          _map.remove(); // Ÿäÿ≠ŸÑ ŸÖÿ¥ŸÉŸÑÿ© "Map container is already initialized"
          _map = null;
          _marker = null;
        }
      } catch (e) {
        _map = null;
        _marker = null;
      }
    }

    function ensureMap() {
      // ŸÑŸà ÿßŸÑÿµŸÅÿ≠ÿ© ÿßÿ™ÿπŸÖŸÑ ŸÑŸáÿß reload ÿØÿßÿÆŸÑ SPA ŸàŸÅÿ∂ŸÑÿ™ ŸÜŸÅÿ≥ ÿßŸÑŸÄ id
      if (_map) return;

      const mapEl = document.getElementById("map");
      if (!mapEl) return;

      // ŸÑŸà Leaflet ÿ¥ÿßŸäŸÅ ÿ•ŸÜ ÿßŸÑŸÉŸàŸÜÿ™ŸäŸÜÿ± ŸÖÿ™ÿ£ÿ´ÿ± ŸÖŸÜ ÿ™ŸáŸäÿ¶ÿ© ŸÇÿØŸäŸÖÿ©
      if (mapEl._leaflet_id) {
        destroyMapIfAny();
        // ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÄ leaflet id ÿßŸÑŸÇÿØŸäŸÖ
        try {
          delete mapEl._leaflet_id;
        } catch {}
      }

      _map = L.map("map", { zoomControl: true }).setView([25.2, 55.3], 10);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap",
      }).addTo(_map);
    }

    function showPointOnMap(lat, lon) {
      _lastLatLon = { lat, lon };

      const box = document.getElementById("mapBox");
      if (box) box.style.display = "block";

      // ŸÖŸáŸÖ ÿ¨ÿØŸãÿß: ÿßŸÜÿ™ÿ∏ÿ± frame Ÿàÿßÿ≠ÿØÿ© ÿ®ÿπÿØ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÄ div
      requestAnimationFrame(() => {
        ensureMap();
        if (!_map) return;

        _map.setView([lat, lon], 17);

        if (_marker) _map.removeLayer(_marker);

        // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿßÿ±ŸÉÿ± SVG ŸÖÿØŸÖÿ¨ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ ÿπŸÑŸâ CDN ÿÆÿßÿ±ÿ¨Ÿä
        const markerIcon = L.divIcon({
          html: `<svg width="40" height="50" viewBox="0 0 40 50" xmlns="http://www.w3.org/2000/svg">
            <path d="M 20 0 C 8.954 0 0 8.954 0 20 C 0 35 20 50 20 50 S 40 35 40 20 C 40 8.954 31.046 0 20 0 Z" fill="#FF0000" stroke="#FFF" stroke-width="2"/>
            <circle cx="20" cy="20" r="8" fill="#FFF"/>
          </svg>`,
          className: "custom-marker",
          iconSize: [40, 50],
          iconAnchor: [20, 50],
          popupAnchor: [0, -50],
        });

        _marker = L.marker([lat, lon], { icon: markerIcon })
          .addTo(_map)
          .bindPopup(
            `<div style="font-family: Cairo, sans-serif; color: #333;"><b>üìç ÿßŸÑŸÜŸÇÿ∑ÿ©</b><br/>Lat: ${lat.toFixed(6)}<br/>Lon: ${lon.toFixed(6)}</div>`,
            {
              className: "custom-popup",
            },
          );

        // ŸÅÿ™ÿ≠ ÿßŸÑÿ®Ÿàÿ® ÿ£ÿ® ŸÑŸÑŸÖÿßÿ±ŸÉÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        _marker.openPopup();

        // ÿßŸÑÿ£ŸáŸÖ: ÿßÿ¨ÿ®ÿßÿ± Leaflet ŸäÿπŸäÿØ ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸÇÿßÿ≥ÿßÿ™
        setTimeout(() => {
          try {
            _map.invalidateSize(true);
          } catch {}
        }, 120);
      });
    }

    window.openGoogleMapsLink = function () {
      if (!_lastLatLon) return alert("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜŸÇÿ∑ÿ© ŸÑŸÑÿπÿ±ÿ∂");
      const url = `https://www.google.com/maps?q=${_lastLatLon.lat},${_lastLatLon.lon}`;
      window.open(url, "_blank");
    };

    window.downloadSingleKml = function () {
      if (!_lastLatLon) return alert("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜŸÇÿ∑ÿ© ŸÑŸÑÿ™ÿµÿØŸäÿ±");
      const { lat, lon } = _lastLatLon;
      const kml = `<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
    <Placemark>
      <name>DLTM Convert</name>
      <Point><coordinates>${lon},${lat},0</coordinates></Point>
    </Placemark>
  </kml>`;
      const blob = new Blob([kml], {
        type: "application/vnd.google-earth.kml+xml;charset=utf-8",
      });
      const u = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = u;
      a.download = "point.kml";
      a.click();
      URL.revokeObjectURL(u);
    };

    window.runReverseDltm = function () {
      const inputType =
        document.querySelector("input[name='rev-input-type']:checked")?.value ||
        "wgs84";

      if (inputType === "wgs84") {
        const lon = parseFloat(document.getElementById("inp-lon").value);
        const lat = parseFloat(document.getElementById("inp-lat").value);
        if (isNaN(lat) || isNaN(lon))
          return alert("ÿ£ÿØÿÆŸÑ Latitude/Longitude ÿµÿ≠Ÿäÿ≠ŸäŸÜ");
        saveLastInputs();
        const r = convertWGS84toDLTM(lat, lon);
        if (!r.success) return alert("ÿÆÿ∑ÿ£: " + r.error);
        document.getElementById("res-dltm-e").innerText = r.easting.toFixed(3);
        document.getElementById("res-dltm-n").innerText = r.northing.toFixed(3);
        const note = document.getElementById("reverse-note");
        if (note) {
          note.style.display = "block";
          note.innerText =
            "ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÜ WGS84 ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ®ÿßÿ±ÿßŸÖŸäÿ™ÿ±ÿßÿ™ DLTM (lon0=55¬∞20‚Ä≤, FE=500000, k0=1.0).";
        }
        document.getElementById("reverse-box").style.display = "block";
      } else {
        // ÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÜ UTM
        const zone = document.getElementById("inp-utm-zone").value.trim();
        const utmE = parseFloat(document.getElementById("inp-utm-e").value);
        const utmN = parseFloat(document.getElementById("inp-utm-n").value);
        if (!zone || isNaN(utmE) || isNaN(utmN))
          return alert("ÿ£ÿØÿÆŸÑ UTM Zone, Easting, Northing ÿµÿ≠Ÿäÿ≠ÿ©");

        saveLastInputs();
        const r = convertUTMtoDLTM(zone, utmE, utmN);
        if (!r.success) return alert("ÿÆÿ∑ÿ£: " + r.error);
        document.getElementById("res-dltm-e").innerText = r.easting.toFixed(3);
        document.getElementById("res-dltm-n").innerText = r.northing.toFixed(3);
        const note = document.getElementById("reverse-note");
        if (note) {
          note.style.display = "block";
          note.innerText = "ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÜ UTM ÿ•ŸÑŸâ DLTM.";
        }
        document.getElementById("reverse-box").style.display = "block";
      }
    };

    window.copyReverse = async function (mode) {
      const e = document.getElementById("res-dltm-e")?.innerText || "";
      const n = document.getElementById("res-dltm-n")?.innerText || "";
      const lon = document.getElementById("inp-lon")?.value || "";
      const lat = document.getElementById("inp-lat")?.value || "";
      const text =
        mode === "dltm"
          ? `Easting: ${e}\nNorthing: ${n}`
          : `Longitude: ${lon}\nLatitude: ${lat}`;
      const ok = await copyTextSmart(text);
      alert(ok ? "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ‚úÖ" : "ÿ™ÿπÿ∞ÿ± ÿßŸÑŸÜÿ≥ÿÆ ‚ùå");
    };

    window.showOnMapFromWgs = function () {
      const inputType =
        document.querySelector("input[name='rev-input-type']:checked")?.value ||
        "wgs84";

      if (inputType === "wgs84") {
        const lon = parseFloat(document.getElementById("inp-lon").value);
        const lat = parseFloat(document.getElementById("inp-lat").value);
        if (isNaN(lat) || isNaN(lon))
          return alert("ÿ£ÿØÿÆŸÑ Latitude/Longitude ÿµÿ≠Ÿäÿ≠ŸäŸÜ");
        showPointOnMap(lat, lon);
      } else {
        const zone = document.getElementById("inp-utm-zone").value.trim();
        const utmE = parseFloat(document.getElementById("inp-utm-e").value);
        const utmN = parseFloat(document.getElementById("inp-utm-n").value);
        if (!zone || isNaN(utmE) || isNaN(utmN))
          return alert("ÿ£ÿØÿÆŸÑ UTM Zone, Easting, Northing ÿµÿ≠Ÿäÿ≠ÿ©");
        const wgs = convertUTMtoWGS84(zone, utmE, utmN);
        if (!wgs.success) return alert("Error: " + wgs.error);
        showPointOnMap(wgs.latitude, wgs.longitude);
      }
    };

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function safeCsv(s) {
      const v = String(s ?? "");
      if (/[",\n]/.test(v)) return `"${v.replace(/"/g, '""')}"`;
      return v;
    }

    function fallbackCopyText(text) {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.top = "-9999px";
      ta.style.opacity = "0";
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, ta.value.length);

      let ok = false;
      try {
        ok = document.execCommand("copy");
      } catch (e) {
        ok = false;
      }
      document.body.removeChild(ta);
      return ok;
    }

    async function copyTextSmart(text) {
      // Try modern clipboard first
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (e) {
        // ignore and fallback
      }
      // Fallback
      return fallbackCopyText(text);
    }

    window.copySingle = async function (mode) {
      const lonDms = document.getElementById("res-lon-dms")?.innerText || "";
      const latDms = document.getElementById("res-lat-dms")?.innerText || "";
      const lonDd = document.getElementById("res-lon-dd")?.innerText || "";
      const latDd = document.getElementById("res-lat-dd")?.innerText || "";
      const utmZ = document.getElementById("res-utm-z")?.innerText || "";
      const utmE = document.getElementById("res-utm-e")?.innerText || "";
      const utmN = document.getElementById("res-utm-n")?.innerText || "";

      let text = "";
      if (mode === "dms")
        text = `Longitude (DMS): ${lonDms}\nLatitude (DMS): ${latDms}`;
      else if (mode === "dd")
        text = `Longitude (Decimal): ${lonDd}\nLatitude (Decimal): ${latDd}`;
      else text = `UTM: ${utmZ}\nEasting: ${utmE}\nNorthing: ${utmN}`;

      const ok = await copyTextSmart(text);
      alert(ok ? "Copied ‚úÖ" : "Copy failed ‚ùå");
    };

    // ----------------------------
    // Local Storage for Last Inputs
    // ----------------------------
    window.saveLastInputs = function () {
      const e = document.getElementById("inp-e").value;
      const n = document.getElementById("inp-n").value;
      const lon = document.getElementById("inp-lon").value;
      const lat = document.getElementById("inp-lat").value;
      const format = document.getElementById("out-format").value;
      const precision = document.getElementById("out-prec").value;

      localStorage.setItem("dltm_lastE", e);
      localStorage.setItem("dltm_lastN", n);
      localStorage.setItem("dltm_lastLon", lon);
      localStorage.setItem("dltm_lastLat", lat);
      localStorage.setItem("dltm_lastFormat", format);
      localStorage.setItem("dltm_lastPrecision", precision);
    };

    window.loadLastInputs = function () {
      const e = localStorage.getItem("dltm_lastE");
      const n = localStorage.getItem("dltm_lastN");
      const lon = localStorage.getItem("dltm_lastLon");
      const lat = localStorage.getItem("dltm_lastLat");
      const format = localStorage.getItem("dltm_lastFormat") || "dms";
      const precision = localStorage.getItem("dltm_lastPrecision") || "8";

      if (e) document.getElementById("inp-e").value = e;
      if (n) document.getElementById("inp-n").value = n;
      if (lon) document.getElementById("inp-lon").value = lon;
      if (lat) document.getElementById("inp-lat").value = lat;
      document.getElementById("out-format").value = format;
      document.getElementById("out-prec").value = precision;
    };

    window.clearLastInputs = function () {
      localStorage.removeItem("dltm_lastE");
      localStorage.removeItem("dltm_lastN");
      localStorage.removeItem("dltm_lastLon");
      localStorage.removeItem("dltm_lastLat");
      localStorage.removeItem("dltm_lastFormat");
      localStorage.removeItem("dltm_lastPrecision");
      localStorage.removeItem("dltm_lastUtmZone");
      localStorage.removeItem("dltm_lastUtmE");
      localStorage.removeItem("dltm_lastUtmN");
      localStorage.removeItem("dltm_lastInputType");
      document.getElementById("inp-e").value = "";
      document.getElementById("inp-n").value = "";
      document.getElementById("inp-lon").value = "";
      document.getElementById("inp-lat").value = "";
      document.getElementById("inp-utm-zone").value = "";
      document.getElementById("inp-utm-e").value = "";
      document.getElementById("inp-utm-n").value = "";
      alert("ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ‚ú®");
    };

    // ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ŸÜŸàÿπ ÿßŸÑŸÖÿØÿÆŸÑ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿπŸÉÿ≥Ÿä
    window.switchReverseInputType = function (type) {
      const wgs84Inputs = document.getElementById("wgs84-inputs");
      const utmInputs = document.getElementById("utm-inputs");

      if (type === "wgs84") {
        wgs84Inputs.style.display = "grid";
        utmInputs.style.display = "none";
      } else {
        wgs84Inputs.style.display = "none";
        utmInputs.style.display = "grid";
      }

      localStorage.setItem("dltm_lastInputType", type);
    };

    // ÿØÿßŸÑÿ© ÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÜ UTM ÿ•ŸÑŸâ WGS84
    function convertUTMtoWGS84(zone, easting, northing) {
      try {
        const a = 6378137.0;
        const invF = 298.257223563;
        const f = 1 / invF;
        const b = a * (1 - f);
        const e2 = (a * a - b * b) / (a * a);
        const ep2 = (a * a - b * b) / (b * b);

        // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ hemisphere ŸÖŸÜ zone (e.g., "40N" ‚Üí hemisphere = "N")
        const hemMatch = zone.match(/([NSEW])$/i);
        const hemisphere = hemMatch ? hemMatch[1].toUpperCase() : "N";
        const zoneNum = parseInt(zone.match(/\d+/)[0]);

        const k0 = 0.9996;
        const lon0 = degToRad((zoneNum - 1) * 6 - 180 + 3);
        const lat0 = 0;
        const E0 = 500000;
        const N0 = hemisphere === "N" ? 0 : 10000000;

        const x = easting - E0;
        const y = northing - N0;

        const M = y / k0;
        const mu =
          M /
          (a * (1 - e2 / 4 - (3 * e2 * e2) / 64 - (5 * e2 * e2 * e2) / 256));

        const C1 =
          (3 * e2) / 8 + (3 * e2 * e2) / 32 + (45 * e2 * e2 * e2) / 1024;
        const C2 = (15 * e2 * e2) / 256 + (45 * e2 * e2 * e2) / 1024;
        const C3 = (35 * e2 * e2 * e2) / 3072;

        const p1 =
          mu -
          C1 * Math.sin(2 * mu) +
          C2 * Math.sin(4 * mu) -
          C3 * Math.sin(6 * mu);

        const p1sin = Math.sin(p1);
        const p1cos = Math.cos(p1);

        const N = a / Math.sqrt(1 - e2 * p1sin * p1sin);
        const T = Math.tan(p1) * Math.tan(p1);
        const C = ep2 * p1cos * p1cos;
        const R =
          (a * (1 - e2)) / Math.sqrt(Math.pow(1 - e2 * p1sin * p1sin, 3));
        const D = x / (N * k0);

        const lat =
          p1 -
          (Math.tan(p1) / R) *
            ((D * D) / 2 -
              ((D * D * D * D) / 24) *
                (5 + 3 * T + 10 * C - 4 * C * C - 9 * ep2) +
              ((D * D * D * D * D * D) / 720) *
                (61 + 90 * T + 28 * T * T + 45 * C - 252 * ep2 - 3 * C * C));

        const lon =
          (D -
            ((D * D * D) / 6) * (1 + 2 * T + C) +
            ((D * D * D * D * D) / 120) *
              (5 - 2 * C + 28 * T - 3 * C * C + 8 * ep2 + 24 * T * T)) /
            p1cos +
          lon0;

        return {
          success: true,
          latitude: radToDeg(lat),
          longitude: radToDeg(lon),
        };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    // ÿØÿßŸÑÿ© ÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÜ UTM ÿ•ŸÑŸâ DLTM
    function convertUTMtoDLTM(zone, easting, northing) {
      try {
        const wgs = convertUTMtoWGS84(zone, easting, northing);
        if (!wgs.success) return wgs;

        return convertWGS84toDLTM(wgs.latitude, wgs.longitude);
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    window.saveLastInputs = function () {
      const e = document.getElementById("inp-e").value;
      const n = document.getElementById("inp-n").value;
      const lon = document.getElementById("inp-lon").value;
      const lat = document.getElementById("inp-lat").value;
      const format = document.getElementById("out-format").value;
      const precision = document.getElementById("out-prec").value;
      const inputType =
        document.querySelector("input[name='rev-input-type']:checked")?.value ||
        "wgs84";
      const utmZone = document.getElementById("inp-utm-zone").value;
      const utmE = document.getElementById("inp-utm-e").value;
      const utmN = document.getElementById("inp-utm-n").value;

      localStorage.setItem("dltm_lastE", e);
      localStorage.setItem("dltm_lastN", n);
      localStorage.setItem("dltm_lastLon", lon);
      localStorage.setItem("dltm_lastLat", lat);
      localStorage.setItem("dltm_lastFormat", format);
      localStorage.setItem("dltm_lastPrecision", precision);
      localStorage.setItem("dltm_lastInputType", inputType);
      localStorage.setItem("dltm_lastUtmZone", utmZone);
      localStorage.setItem("dltm_lastUtmE", utmE);
      localStorage.setItem("dltm_lastUtmN", utmN);
    };

    // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    window.loadLastInputs = function () {
      const e = localStorage.getItem("dltm_lastE");
      const n = localStorage.getItem("dltm_lastN");
      const lon = localStorage.getItem("dltm_lastLon");
      const lat = localStorage.getItem("dltm_lastLat");
      const format = localStorage.getItem("dltm_lastFormat") || "dms";
      const precision = localStorage.getItem("dltm_lastPrecision") || "8";
      const inputType = localStorage.getItem("dltm_lastInputType") || "wgs84";
      const utmZone = localStorage.getItem("dltm_lastUtmZone");
      const utmE = localStorage.getItem("dltm_lastUtmE");
      const utmN = localStorage.getItem("dltm_lastUtmN");

      if (e) document.getElementById("inp-e").value = e;
      if (n) document.getElementById("inp-n").value = n;
      if (lon) document.getElementById("inp-lon").value = lon;
      if (lat) document.getElementById("inp-lat").value = lat;
      if (utmZone) document.getElementById("inp-utm-zone").value = utmZone;
      if (utmE) document.getElementById("inp-utm-e").value = utmE;
      if (utmN) document.getElementById("inp-utm-n").value = utmN;

      document.getElementById("out-format").value = format;
      document.getElementById("out-prec").value = precision;

      // ÿ™ÿ®ÿØŸäŸÑ ŸÜŸàÿπ ÿßŸÑŸÖÿØÿÆŸÑ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿπŸÉÿ≥Ÿä
      document.querySelector(
        `input[name='rev-input-type'][value='${inputType}']`,
      ).checked = true;
      switchReverseInputType(inputType);
    };

    // Load saved inputs on page load
    loadLastInputs();

    // Test function for batch conversion
    window.testBatchConversion = function () {
      // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÖŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ ÿ£Ÿà ŸÖŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ
      if (!batchData || batchData.length === 0) {
        console.log("‚ùå No data loaded. Please upload a CSV file first.");
        return;
      }

      console.log("‚úì ÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÖŸÑÿ©:", batchData.length, "ÿµŸÅ");
      console.table(batchData);

      return batchData;
    };
  })();
</script>
</body>
</html>