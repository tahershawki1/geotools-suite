<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoTools Suite</title>

    <!-- Unified shared modules -->
    <script src="./shared/js/navbar-loader.js"></script>
    <script src="./shared/js/footer-loader.js"></script>
    <script src="./shared/js/keyboard-navigation.js"></script>
    <script src="./shared/js/notification-system.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Global libraries for SPA tools -->
    <script src="./vendor/proj4.js"></script>
    <link rel="stylesheet" href="./vendor/leaflet/leaflet.css" />
    <script src="./vendor/leaflet/leaflet.js"></script>

    <!-- Global styles -->
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <div
      id="loader"
      role="status"
      aria-live="polite"
      aria-hidden="true"
      aria-label="Loading page content"
    >
      <div class="loader-content">
        <div class="spinner"></div>
        <div class="loader-text">Loading...</div>
      </div>
    </div>

    <div id="app-container">
      <main id="view-content" class="dashboard-view" tabindex="-1" aria-busy="false">
        <div class="header">
          <h1>GeoTools Survey Suite</h1>
          <p>Choose the service you want to use today</p>
        </div>

        <div class="grid">
          <button
            class="card"
            type="button"
            onclick="loadPage('file-converter')"
            aria-label="Open File Converter tool"
          >
            <div class="icon-box">üîÑ</div>
            <h2>File Converter (SDR)</h2>
            <p>
              Convert coordinate CSV/TXT files to SDR format for Sokkia devices,
              with map view feature.
            </p>
          </button>

          <button
            class="card"
            type="button"
            onclick="loadPage('dltm-converter')"
            aria-label="Open DLTM Converter tool"
          >
            <div class="icon-box">üìç</div>
            <h2>DLTM Converter (Dubai)</h2>
            <p>
              Convert Dubai local coordinates (DLTM) to global coordinates
              (Lat/Long) with high accuracy.
            </p>
          </button>

          <button
            class="card"
            type="button"
            onclick="loadPage('area-calculator')"
            aria-label="Open Area Calculator tool"
          >
            <div class="icon-box">üìê</div>
            <h2>Area Calculator</h2>
            <p>
              Engineering tool for calculating areas based on coordinates or distances
              and angles.
            </p>
          </button>

          <button
            class="card"
            type="button"
            onclick="loadPage('coordinate-transform')"
            aria-label="Open Coordinate Transformation tool"
          >
            <div class="icon-box">üõ∞Ô∏è</div>
            <h2>Coordinate Transformation</h2>
            <p>
              Convert coordinates between different systems UTM, WGS84 and others using
              Proj4js.
            </p>
          </button>
        </div>
      </main>
    </div>

    <script>
      console.log("GeoTools SPA fetch-loader active - v2026-02-08");

      const appContainer = document.getElementById("app-container");
      const contentDiv = document.getElementById("view-content");
      const loaderElement = document.getElementById("loader");
      const defaultMeta = {
        lang: document.documentElement.lang || "en",
        dir: document.documentElement.dir || "ltr",
        title: document.title,
      };

      let dashboardHtml = "";
      let leafletObserver = null;
      let autoFieldCounter = 0;
      const PAGE_ROUTES = {
        "file-converter": "./pages/file-converter.html",
        "dltm-converter": "./pages/dltm-converter.html",
        "coordinate-transform": "./pages/coordinate-transform.html",
        "area-calculator": "./pages/area-calculator.html",
      };

      function showLoader(show) {
        loaderElement.style.display = show ? "flex" : "none";
        loaderElement.setAttribute("aria-hidden", show ? "false" : "true");
        contentDiv.setAttribute("aria-busy", show ? "true" : "false");
      }

      function setDocumentMeta(meta) {
        document.documentElement.lang = meta.lang || defaultMeta.lang;
        document.documentElement.dir = meta.dir || defaultMeta.dir;
        document.title = meta.title || defaultMeta.title;
      }

      function notifyLoadError(message) {
        if (typeof window.showError === "function") {
          window.showError(message, "Error");
          return;
        }
        console.error(message);
      }

      function ensureLabelAssociations(root) {
        if (!root) return;
        const labels = root.querySelectorAll("label:not([for])");

        labels.forEach((label) => {
          let control =
            label.querySelector("input, select, textarea") ||
            (label.nextElementSibling &&
            /^(INPUT|SELECT|TEXTAREA)$/.test(label.nextElementSibling.tagName)
              ? label.nextElementSibling
              : null);

          if (!control && label.parentElement) {
            control = label.parentElement.querySelector("input, select, textarea");
          }
          if (!control) return;

          if (!control.id) {
            autoFieldCounter += 1;
            control.id = "auto-field-" + autoFieldCounter;
          }
          label.setAttribute("for", control.id);
        });
      }

      function enhanceLeafletAccessibility(root) {
        const scope = root || document;

        scope.querySelectorAll(".leaflet-control-zoom-in").forEach((el) => {
          if (!el.getAttribute("aria-label")) {
            el.setAttribute("aria-label", "Zoom in");
          }
          el.setAttribute("role", "button");
        });

        scope.querySelectorAll(".leaflet-control-zoom-out").forEach((el) => {
          if (!el.getAttribute("aria-label")) {
            el.setAttribute("aria-label", "Zoom out");
          }
          el.setAttribute("role", "button");
        });

        scope.querySelectorAll(".leaflet-container").forEach((el) => {
          if (!el.getAttribute("aria-label")) {
            el.setAttribute("aria-label", "Interactive map");
          }
        });

        scope.querySelectorAll(".leaflet-popup-close-button").forEach((el) => {
          if (!el.getAttribute("aria-label")) {
            el.setAttribute("aria-label", "Close popup");
          }
        });
      }

      function installLeafletObserver() {
        if (leafletObserver || typeof MutationObserver === "undefined") return;

        leafletObserver = new MutationObserver(() => {
          enhanceLeafletAccessibility(document);
        });

        leafletObserver.observe(document.body, {
          childList: true,
          subtree: true,
        });
      }

      function removeMapArtifacts() {
        try {
          if (window.map && typeof window.map.remove === "function") {
            window.map.remove();
            delete window.map;
          }
          if (window._map && typeof window._map.remove === "function") {
            window._map.remove();
            delete window._map;
          }
          document.querySelectorAll("#view-content .leaflet-container").forEach((el) => {
            el.remove();
          });
        } catch (error) {
          console.warn("Map cleanup warning:", error);
        }
      }

      function parsePage(html) {
        const parser = new DOMParser();
        const parsed = parser.parseFromString(html, "text/html");
        const nodes = [];

        Array.from(parsed.body.childNodes).forEach((node) => {
          if (node.nodeType === Node.ELEMENT_NODE) {
            const el = node;
            if (el.tagName === "SCRIPT") return;
            if (el.matches(".standalone-footer,[data-standalone-only='true']")) return;
            nodes.push(el.outerHTML);
            return;
          }
          if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
            nodes.push(node.textContent);
          }
        });

        return {
          contentHtml: nodes.join("\n"),
          scripts: Array.from(parsed.querySelectorAll("script")),
          meta: {
            lang: parsed.documentElement.getAttribute("lang") || defaultMeta.lang,
            dir: parsed.documentElement.getAttribute("dir") || defaultMeta.dir,
            title: parsed.title || defaultMeta.title,
          },
        };
      }

      function clearPageScripts() {
        document
          .querySelectorAll("script[data-spa-page-script='true']")
          .forEach((script) => script.remove());
      }

      function isGlobalScript(src) {
        const normalized = src.toLowerCase();
        const ignored = [
          "theme.js",
          "navbar-loader.js",
          "footer-loader.js",
          "keyboard-navigation.js",
          "notification-system.js",
          "vendor/leaflet/leaflet.js",
          "vendor/proj4.js",
          "cdnjs.cloudflare.com/ajax/libs/proj4js",
          "unpkg.com/leaflet",
          "cdn.jsdelivr.net/npm/leaflet",
        ];
        return ignored.some((item) => normalized.includes(item));
      }

      function injectScript(scriptEl, baseUrl) {
        return new Promise((resolve, reject) => {
          const src = scriptEl.getAttribute("src");
          const script = document.createElement("script");
          script.dataset.spaPageScript = "true";
          script.async = false;
          script.defer = false;

          if (src) {
            const resolvedBase = baseUrl || location.href;
            script.src = new URL(src, resolvedBase).href;
            script.onload = resolve;
            script.onerror = () => reject(new Error("Failed to load script: " + src));
            document.body.appendChild(script);
            return;
          }

          script.textContent = scriptEl.textContent || "";
          document.body.appendChild(script);
          resolve();
        });
      }

      async function runPageScripts(scripts, baseUrl) {
        clearPageScripts();
        for (const scriptEl of scripts) {
          const src = scriptEl.getAttribute("src");
          if (src && isGlobalScript(src)) continue;
          await injectScript(scriptEl, baseUrl);
        }
      }

      function finishNavigation(activePage, meta) {
        setDocumentMeta(meta || defaultMeta);
        ensureLabelAssociations(contentDiv);
        enhanceLeafletAccessibility(contentDiv);

        if (window.GeoToolsTheme && typeof window.GeoToolsTheme.reinit === "function") {
          window.GeoToolsTheme.reinit();
        }
        if (typeof window.updatePageIndicator === "function") {
          window.updatePageIndicator(activePage || "home");
        }

        appContainer.style.opacity = "1";
        showLoader(false);
        contentDiv.focus({ preventScroll: true });
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      window.loadPage = async function loadPage(pageName) {
        const normalizedPage = String(pageName || "").toLowerCase();
        if (!normalizedPage || normalizedPage === "home") {
          clearPageScripts();
          contentDiv.innerHTML = dashboardHtml;
          finishNavigation("home", defaultMeta);
          return;
        }

        removeMapArtifacts();
        showLoader(true);
        appContainer.style.opacity = "0.5";

        try {
          const url = PAGE_ROUTES[normalizedPage];
          if (!url) {
            throw new Error("Unknown page: " + pageName);
          }
          const res = await fetch(url, { cache: "no-cache" });
          if (!res.ok) {
            throw new Error("Failed to load " + url + " (HTTP " + res.status + ")");
          }

          const html = await res.text();
          const parsed = parsePage(html);
          const absoluteUrl = new URL(url, location.href).href;

          contentDiv.innerHTML = "";
          await new Promise((resolve) => setTimeout(resolve, 10));
          contentDiv.innerHTML = parsed.contentHtml;
          await runPageScripts(parsed.scripts, absoluteUrl);
          finishNavigation(normalizedPage, parsed.meta);
        } catch (err) {
          notifyLoadError("Error loading page: " + err.message);
          console.error("Page load error:", err);
          appContainer.style.opacity = "1";
          showLoader(false);
        }
      };

      window.addEventListener("DOMContentLoaded", () => {
        dashboardHtml = contentDiv.innerHTML;
        ensureLabelAssociations(contentDiv);
        enhanceLeafletAccessibility(contentDiv);
        installLeafletObserver();
        if (typeof window.updatePageIndicator === "function") {
          window.updatePageIndicator("home");
        }
      });
    </script>
  </body>
</html>
